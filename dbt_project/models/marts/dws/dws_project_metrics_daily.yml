version: 2

models:
  - name: dws_project_metrics_daily
    description: "汇总单个项目在每一天的交付、质量和活跃度指标。"
    columns:
      - name: project_id
        tests:
          - not_null
      - name: metric_date
        tests:
          - not_null

unit_tests:
  - name: test_dws_project_metrics_daily_logic
    model: dws_project_metrics_daily
    given:
      - input: ref('stg_gitlab_projects')
        format: dict
        rows:
          - {gitlab_project_id: 101}
      - input: ref('int_unified_activities')
        format: dict
        rows:
          - {occurred_at: '2024-01-01 10:00:00'}
      - input: ref('stg_gitlab_merge_requests')
        format: dict
        rows:
          - {project_id: 101, created_at: '2024-01-01 11:00:00', state: 'opened'}
          - {project_id: 101, created_at: '2024-01-01 12:00:00', state: 'merged'}
      - input: ref('stg_gitlab_deployments')
        format: dict
        rows:
          - {project_id: 101, created_at: '2024-01-01 13:00:00', environment: 'production', status: 'success'}
          - {project_id: 101, created_at: '2024-01-01 14:00:00', environment: 'production', status: 'failed'}
      - input: ref('dws_project_quality_daily')
        format: dict
        rows:
          - {gitlab_project_id: 101, analysis_day: '2024-01-01', bugs: 5, vulnerabilities: 2, coverage: 85.5, tech_debt_hours: 10.5}
    expect:
      format: dict
      rows:
        - {project_id: 101, metric_date: '2024-01-01', mrs_opened: 2, mrs_merged: 1, prod_deploys: 1, failed_deploys: 1, sonar_bugs: 5, sonar_vulnerabilities: 2, test_coverage_pct: 85.5, tech_debt_hours: 10.5, is_active_day: true}
