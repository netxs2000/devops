"""refactor_rbac_models

Revision ID: 3414408a4c10
Revises: 2a026ee8eec0
Create Date: 2026-01-17 18:34:11.792664

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '3414408a4c10'
down_revision: Union[str, None] = '2a026ee8eec0'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    # op.drop_index('ix_mdm_entities_topology_entity_id', table_name='mdm_entities_topology')
    # op.drop_table('mdm_entities_topology')
    op.drop_table('fct_test_execution_summary')
    op.drop_table('fct_user_activity_profiles')
    op.drop_table('fct_performance_records')
    op.alter_column('commit_metrics', 'commit_id',
               existing_type=sa.VARCHAR(length=100),
               comment='提交SHA哈希值',
               existing_nullable=False)
    op.alter_column('commit_metrics', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment='所属业务项目ID',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'author_email',
               existing_type=sa.VARCHAR(length=255),
               comment='提交者邮箱',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'committed_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='提交时间',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'raw_additions',
               existing_type=sa.INTEGER(),
               comment='原始新增行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'raw_deletions',
               existing_type=sa.INTEGER(),
               comment='原始删除行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'eloc_score',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='有效代码行数得分',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'impact_score',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='代码影响力得分',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'churn_lines',
               existing_type=sa.INTEGER(),
               comment='代码翻动行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'comment_lines',
               existing_type=sa.INTEGER(),
               comment='注释行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'test_lines',
               existing_type=sa.INTEGER(),
               comment='测试代码行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'file_count',
               existing_type=sa.INTEGER(),
               comment='涉及文件数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'is_merge',
               existing_type=sa.BOOLEAN(),
               comment='是否为合并提交',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'is_legacy_refactor',
               existing_type=sa.BOOLEAN(),
               comment='是否为遗留代码重构',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'refactor_ratio',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='重构代码占比',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('daily_dev_stats', 'user_id',
               existing_type=sa.UUID(),
               comment='用户ID',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'date',
               existing_type=sa.DATE(),
               comment='统计日期',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'first_commit_time',
               existing_type=postgresql.TIMESTAMP(),
               comment='当日首次提交时间',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'last_commit_time',
               existing_type=postgresql.TIMESTAMP(),
               comment='当日最后提交时间',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'commit_count',
               existing_type=sa.INTEGER(),
               comment='当日提交次数',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'total_impact',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='当日总影响力得分',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'total_churn',
               existing_type=sa.INTEGER(),
               comment='当日总代码翻动行数',
               existing_nullable=True)
    op.add_column('mdm_business_systems', sa.Column('status', sa.String(length=20), nullable=True, comment='生命周期状态 (PLANNING/DEV/PRODUCTION/DEPRECATED)'))
    op.add_column('mdm_business_systems', sa.Column('rank', sa.String(length=10), nullable=True, comment='重要性分级 (T0/T1/T2/T3)'))
    op.add_column('mdm_business_systems', sa.Column('architecture_type', sa.String(length=50), nullable=True, comment='架构类型 (Microservices/Monolith/Serverless)'))
    op.add_column('mdm_business_systems', sa.Column('primary_tech_stack', sa.String(length=100), nullable=True, comment='主要技术栈 (如 Java/SpringCloud)'))
    op.add_column('mdm_business_systems', sa.Column('dr_level', sa.String(length=50), nullable=True, comment='容灾等级要求 (双活/冷备/单点)'))
    op.add_column('mdm_business_systems', sa.Column('business_owner_id', sa.UUID(), nullable=True, comment='业务负责人 (PDM)'))
    op.alter_column('mdm_business_systems', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_business_systems', 'code',
               existing_type=sa.VARCHAR(length=50),
               comment='系统标准代号 (如 trade-center)',
               existing_nullable=False)
    op.alter_column('mdm_business_systems', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment='系统中文名称',
               existing_nullable=False)
    op.alter_column('mdm_business_systems', 'description',
               existing_type=sa.TEXT(),
               comment='系统业务描述与边界定义',
               existing_nullable=True)
    op.alter_column('mdm_business_systems', 'domain',
               existing_type=sa.VARCHAR(length=50),
               comment='所属业务域 (如 电商/供应链/财务)',
               existing_nullable=True)
    op.alter_column('mdm_business_systems', 'owner_id',
               existing_type=sa.UUID(),
               comment='技术负责人 (Architect)',
               existing_nullable=True)
    op.create_index(op.f('ix_mdm_business_systems_domain'), 'mdm_business_systems', ['domain'], unique=False)
    op.create_foreign_key(None, 'mdm_business_systems', 'mdm_identities', ['business_owner_id'], ['global_user_id'])
    op.alter_column('mdm_calendar', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_calendar', 'date_day',
               existing_type=sa.DATE(),
               comment='日期',
               existing_nullable=False)
    op.alter_column('mdm_calendar', 'year_number',
               existing_type=sa.INTEGER(),
               comment='年份',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'month_number',
               existing_type=sa.INTEGER(),
               comment='月份 (1-12)',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'quarter_number',
               existing_type=sa.INTEGER(),
               comment='季度 (1-4)',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'day_of_week',
               existing_type=sa.INTEGER(),
               comment='星期几 (1=周一, 7=周日)',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'is_workday',
               existing_type=sa.BOOLEAN(),
               comment='是否工作日',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'is_holiday',
               existing_type=sa.BOOLEAN(),
               comment='是否节假日',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'holiday_name',
               existing_type=sa.VARCHAR(length=100),
               comment='节假日名称',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'fiscal_year',
               existing_type=sa.VARCHAR(length=20),
               comment='财年',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'fiscal_quarter',
               existing_type=sa.VARCHAR(length=20),
               comment='财务季度',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'week_of_year',
               existing_type=sa.INTEGER(),
               comment='年内周数',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'season_tag',
               existing_type=sa.VARCHAR(length=20),
               comment='季节标签 (春/夏/秋/冬)',
               existing_nullable=True)
    op.add_column('mdm_company', sa.Column('name', sa.String(length=200), nullable=False, comment='公司注册全称'))
    op.add_column('mdm_company', sa.Column('short_name', sa.String(length=100), nullable=True, comment='公司简称'))
    op.add_column('mdm_company', sa.Column('tax_id', sa.String(length=50), nullable=True, comment='统一社会信用代码/税号'))
    op.add_column('mdm_company', sa.Column('currency', sa.String(length=10), nullable=True, comment='本位币种 (CNY/USD)'))
    op.add_column('mdm_company', sa.Column('fiscal_year_start', sa.String(length=10), nullable=True, comment='财年开始日期 (MM-DD)'))
    op.add_column('mdm_company', sa.Column('registered_address', sa.String(length=255), nullable=True, comment='注册地址'))
    op.add_column('mdm_company', sa.Column('location_id', sa.String(length=50), nullable=True, comment='主要办公地点ID'))
    op.add_column('mdm_company', sa.Column('is_active', sa.Boolean(), nullable=True, comment='是否存续经营'))
    op.add_column('mdm_company', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_company', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('mdm_company', 'company_id',
               existing_type=sa.VARCHAR(length=50),
               comment='公司唯一标识 (如 COM-BJ-01)',
               existing_nullable=False)
    op.create_index(op.f('ix_mdm_company_tax_id'), 'mdm_company', ['tax_id'], unique=True)
    op.create_foreign_key(None, 'mdm_company', 'mdm_locations', ['location_id'], ['location_id'])
    op.add_column('mdm_compliance_issues', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_compliance_issues', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('mdm_compliance_issues', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_compliance_issues', 'issue_type',
               existing_type=sa.VARCHAR(length=50),
               comment='问题类型 (安全漏洞/许可证违规/合规缺失)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'severity',
               existing_type=sa.VARCHAR(length=20),
               comment='严重等级 (Critical/High/Medium/Low)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'entity_id',
               existing_type=sa.VARCHAR(length=100),
               comment='关联实体ID (项目/服务)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'status',
               existing_type=sa.VARCHAR(length=20),
               comment='状态 (OPEN/IN_REVIEW/RESOLVED/ACCEPTED)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'description',
               existing_type=sa.TEXT(),
               comment='问题详情',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'metadata_payload',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='额外元数据 (JSON)',
               existing_nullable=True)
    op.create_index(op.f('ix_mdm_compliance_issues_entity_id'), 'mdm_compliance_issues', ['entity_id'], unique=False)
    op.alter_column('mdm_contract_payment_nodes', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_contract_payment_nodes', 'contract_id',
               existing_type=sa.INTEGER(),
               comment='关联合同ID',
               existing_nullable=False)
    op.alter_column('mdm_contract_payment_nodes', 'node_name',
               existing_type=sa.VARCHAR(length=200),
               comment='节点名称',
               existing_nullable=False)
    op.alter_column('mdm_contract_payment_nodes', 'billing_percentage',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='收款比例 (%)',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'billing_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='收款金额',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'linked_system',
               existing_type=sa.VARCHAR(length=50),
               comment='关联系统 (gitlab/jira/manual)',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'linked_milestone_id',
               existing_type=sa.INTEGER(),
               comment='关联里程碑ID',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'is_achieved',
               existing_type=sa.BOOLEAN(),
               comment='是否已达成',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'achieved_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='达成时间',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_cost_codes_id_seq'::regclass)"))
    op.alter_column('mdm_cost_codes', 'code',
               existing_type=sa.VARCHAR(length=50),
               comment='科目编码',
               existing_nullable=False)
    op.alter_column('mdm_cost_codes', 'name',
               existing_type=sa.VARCHAR(length=200),
               comment='科目名称',
               existing_nullable=False)
    op.alter_column('mdm_cost_codes', 'category',
               existing_type=sa.VARCHAR(length=50),
               comment='科目分类 (人力/硬件/软件/服务)',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'description',
               existing_type=sa.TEXT(),
               comment='科目描述',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'parent_id',
               existing_type=sa.INTEGER(),
               comment='上级科目ID',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'default_capex_opex',
               existing_type=sa.VARCHAR(length=10),
               comment='默认CAPEX/OPEX属性',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否启用',
               existing_nullable=True)
    op.add_column('mdm_entity_topology', sa.Column('resource_name', sa.String(length=200), nullable=True, comment='资源显示名称快照 (如 backend/payment-service)'))
    op.add_column('mdm_entity_topology', sa.Column('env_tag', sa.String(length=20), nullable=True, comment='环境标签 (PROD/UAT/TEST/DEV)'))
    op.add_column('mdm_entity_topology', sa.Column('effective_from', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_entity_topology', sa.Column('effective_to', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_entity_topology', sa.Column('is_deleted', sa.Boolean(), nullable=True))
    op.alter_column('mdm_entity_topology', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_entity_topology', 'service_id',
               existing_type=sa.INTEGER(),
               comment='所属业务服务ID',
               existing_nullable=False)
    op.alter_column('mdm_entity_topology', 'system_code',
               existing_type=sa.VARCHAR(length=50),
               comment='来源系统代码 (如 gitlab-corp)',
               existing_nullable=False)
    op.alter_column('mdm_entity_topology', 'external_resource_id',
               existing_type=sa.VARCHAR(length=100),
               comment='外部资源唯一标识 (如 Project ID, Repo URL)',
               existing_nullable=False)
    op.alter_column('mdm_entity_topology', 'element_type',
               existing_type=sa.VARCHAR(length=50),
               comment='资源类型 (source-code/ci-pipeline/k8s-deployment/db-instance)',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='关联是否有效',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'last_verified_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='最后一次验证连接有效的时间',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'meta_info',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='额外元数据连接信息 (JSON, 如 webhook_id, bind_key)',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'sync_version',
               existing_type=sa.INTEGER(),
               nullable=False)
    op.create_index(op.f('ix_mdm_entity_topology_is_current'), 'mdm_entity_topology', ['is_current'], unique=False)
    op.add_column('mdm_epic', sa.Column('parent_id', sa.Integer(), nullable=True, comment='父级 Epic ID (支持多层级)'))
    op.add_column('mdm_epic', sa.Column('epic_code', sa.String(length=50), nullable=False, comment='史诗唯一编码 (如 EPIC-24Q1-001)'))
    op.add_column('mdm_epic', sa.Column('title', sa.String(length=200), nullable=False, comment='史诗标题'))
    op.add_column('mdm_epic', sa.Column('description', sa.Text(), nullable=True, comment='价值陈述与详细描述'))
    op.add_column('mdm_epic', sa.Column('status', sa.String(length=50), nullable=True, comment='状态 (ANALYSIS/BACKLOG/IN_PROGRESS/DONE/CANCELLED)'))
    op.add_column('mdm_epic', sa.Column('priority', sa.String(length=20), nullable=True, comment='优先级 (P0-Strategic / P1-High)'))
    op.add_column('mdm_epic', sa.Column('okr_objective_id', sa.Integer(), nullable=True, comment='关联战略目标ID'))
    op.add_column('mdm_epic', sa.Column('investment_theme', sa.String(length=100), nullable=True, comment='投资主题 (如 技术债/新业务/合规/客户体验)'))
    op.add_column('mdm_epic', sa.Column('budget_cap', sa.Float(), nullable=True, comment='预算上限 (人天或金额)'))
    op.add_column('mdm_epic', sa.Column('owner_id', sa.UUID(), nullable=True, comment='史诗负责人ID (Epic Owner)'))
    op.add_column('mdm_epic', sa.Column('group_id', sa.String(length=100), nullable=True, comment='所属群组/组织ID (GitLab Group)'))
    op.add_column('mdm_epic', sa.Column('start_date_is_fixed', sa.Boolean(), nullable=True, comment='是否固定开始时间 (False则自动继承子任务)'))
    op.add_column('mdm_epic', sa.Column('due_date_is_fixed', sa.Boolean(), nullable=True, comment='是否固定结束时间'))
    op.add_column('mdm_epic', sa.Column('planned_start_date', sa.Date(), nullable=True, comment='计划开始日期'))
    op.add_column('mdm_epic', sa.Column('planned_end_date', sa.Date(), nullable=True, comment='计划完成日期'))
    op.add_column('mdm_epic', sa.Column('actual_start_date', sa.Date(), nullable=True, comment='实际开始日期'))
    op.add_column('mdm_epic', sa.Column('actual_end_date', sa.Date(), nullable=True, comment='实际完成日期'))
    op.add_column('mdm_epic', sa.Column('progress', sa.Float(), nullable=True, comment='总体进度 (0.0-1.0, 基于子任务聚合)'))
    op.add_column('mdm_epic', sa.Column('color', sa.String(length=20), nullable=True, comment='Roadmap展示颜色 (Hex Code)'))
    op.add_column('mdm_epic', sa.Column('is_confidential', sa.Boolean(), nullable=True, comment='是否机密 Epic'))
    op.add_column('mdm_epic', sa.Column('web_url', sa.String(length=255), nullable=True, comment='GitLab 原始链接'))
    op.add_column('mdm_epic', sa.Column('external_id', sa.String(length=50), nullable=True, comment='外部系统ID (如 GitLab Epic IID)'))
    op.add_column('mdm_epic', sa.Column('involved_teams', sa.JSON(), nullable=True, comment='涉及团队列表 (JSON List)'))
    op.add_column('mdm_epic', sa.Column('tags', sa.JSON(), nullable=True, comment='标签 (JSON List)'))
    op.add_column('mdm_epic', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_epic', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('mdm_epic', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.create_index(op.f('ix_mdm_epic_epic_code'), 'mdm_epic', ['epic_code'], unique=True)
    op.create_foreign_key(None, 'mdm_epic', 'mdm_organizations', ['group_id'], ['org_id'])
    op.create_foreign_key(None, 'mdm_epic', 'mdm_epic', ['parent_id'], ['id'])
    op.create_foreign_key(None, 'mdm_epic', 'mdm_identities', ['owner_id'], ['global_user_id'])
    op.create_foreign_key(None, 'mdm_epic', 'mdm_okr_objectives', ['okr_objective_id'], ['id'])
    op.alter_column('mdm_identities', 'global_user_id',
               existing_type=sa.UUID(),
               comment='全局唯一用户标识',
               existing_nullable=False)
    op.alter_column('mdm_identities', 'employee_id',
               existing_type=sa.VARCHAR(length=50),
               comment='HR系统工号',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'username',
               existing_type=sa.VARCHAR(length=100),
               comment='登录用户名',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'full_name',
               existing_type=sa.VARCHAR(length=200),
               comment='用户姓名',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'primary_email',
               existing_type=sa.VARCHAR(length=255),
               comment='主邮箱地址',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'department_id',
               existing_type=sa.VARCHAR(length=100),
               comment='所属部门ID',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否在职',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'is_survivor',
               existing_type=sa.BOOLEAN(),
               comment='是否通过合并保留的账号',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'total_eloc',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='累计有效代码行数',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'eloc_rank',
               existing_type=sa.INTEGER(),
               comment='ELOC排名',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_identity_mappings', 'global_user_id',
               existing_type=sa.UUID(),
               comment='全局用户ID',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'source_system',
               existing_type=sa.VARCHAR(length=50),
               comment='来源系统 (gitlab/jira/sonar)',
               existing_nullable=False)
    op.alter_column('mdm_identity_mappings', 'external_user_id',
               existing_type=sa.VARCHAR(length=100),
               comment='外部系统用户ID',
               existing_nullable=False)
    op.alter_column('mdm_identity_mappings', 'external_username',
               existing_type=sa.VARCHAR(length=100),
               comment='外部系统用户名',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'external_email',
               existing_type=sa.VARCHAR(length=100),
               comment='外部系统邮箱',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'mapping_status',
               existing_type=sa.VARCHAR(length=20),
               comment='映射状态 (VERIFIED/PENDING/REJECTED)',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'confidence_score',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='匹配置信度 (0.0-1.0)',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'last_active_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='最后活跃时间',
               existing_nullable=True)
    op.add_column('mdm_incidents', sa.Column('title', sa.String(length=200), nullable=False, comment='事故标题'))
    op.add_column('mdm_incidents', sa.Column('description', sa.Text(), nullable=True, comment='事故详细描述'))
    op.add_column('mdm_incidents', sa.Column('severity', sa.String(length=20), nullable=True, comment='严重等级 (P0/P1/P2/P3)'))
    op.add_column('mdm_incidents', sa.Column('status', sa.String(length=20), nullable=True, comment='状态 (OPEN:处理中 / RESOLVED:已恢复 / CLOSED:已结单 / MONITORING:观察中)'))
    op.add_column('mdm_incidents', sa.Column('occurred_at', sa.DateTime(timezone=True), nullable=True, comment='故障发生时间 (用于计算 TTI: Time to Impact)'))
    op.add_column('mdm_incidents', sa.Column('detected_at', sa.DateTime(timezone=True), nullable=True, comment='故障发现时间 (用于计算 MTTD: Time to Detect)'))
    op.add_column('mdm_incidents', sa.Column('resolved_at', sa.DateTime(timezone=True), nullable=True, comment='业务恢复时间 (用于计算 MTTR: Time to Restore)'))
    op.add_column('mdm_incidents', sa.Column('location_id', sa.String(length=50), nullable=True, comment='故障发生地点ID'))
    op.add_column('mdm_incidents', sa.Column('root_cause_category', sa.String(length=50), nullable=True, comment='根因分类 (Code Change/Config Change/Capacity/Infrastructure/Exteanl)'))
    op.add_column('mdm_incidents', sa.Column('post_mortem_url', sa.String(length=255), nullable=True, comment='复盘报告链接 (Confluence/Doc URL)'))
    op.add_column('mdm_incidents', sa.Column('affected_users', sa.Integer(), nullable=True, comment='受影响用户数量预估'))
    op.add_column('mdm_incidents', sa.Column('financial_loss', sa.Float(), nullable=True, comment='预估经济损失金额 (CNY)'))
    op.add_column('mdm_incidents', sa.Column('owner_id', sa.UUID(), nullable=True, comment='主责任人ID (On-call)'))
    op.add_column('mdm_incidents', sa.Column('project_id', sa.String(length=100), nullable=True, comment='关联项目ID'))
    op.add_column('mdm_incidents', sa.Column('service_id', sa.Integer(), nullable=True, comment='故障服务ID'))
    op.add_column('mdm_incidents', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_incidents', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('mdm_incidents', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.create_foreign_key(None, 'mdm_incidents', 'mdm_locations', ['location_id'], ['location_id'])
    op.create_foreign_key(None, 'mdm_incidents', 'mdm_projects', ['project_id'], ['project_id'])
    op.create_foreign_key(None, 'mdm_incidents', 'mdm_identities', ['owner_id'], ['global_user_id'])
    op.create_foreign_key(None, 'mdm_incidents', 'mdm_services', ['service_id'], ['id'])
    op.alter_column('mdm_labor_rate_config', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_labor_rate_config', 'job_title_level',
               existing_type=sa.VARCHAR(length=50),
               comment='职级 (P5/P6/P7/M1/M2)',
               existing_nullable=False)
    op.alter_column('mdm_labor_rate_config', 'daily_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='日费率 (元)',
               existing_nullable=False)
    op.alter_column('mdm_labor_rate_config', 'hourly_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='时费率 (元)',
               existing_nullable=True)
    op.alter_column('mdm_labor_rate_config', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment='币种',
               existing_nullable=True)
    op.alter_column('mdm_labor_rate_config', 'effective_date',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='生效日期',
               existing_nullable=True)
    op.alter_column('mdm_labor_rate_config', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否启用',
               existing_nullable=True)
    op.add_column('mdm_locations', sa.Column('code', sa.String(length=20), nullable=True, comment='行政区划或业务编码 (如 CN-GD, 440000)'))
    op.alter_column('mdm_locations', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_locations', 'location_id',
               existing_type=sa.VARCHAR(length=50),
               comment='位置唯一标识 (如 UUID)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'location_name',
               existing_type=sa.VARCHAR(length=200),
               comment='位置名称 (如 广东省)',
               existing_nullable=False)
    op.alter_column('mdm_locations', 'short_name',
               existing_type=sa.VARCHAR(length=50),
               comment='简称 (如 广东)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'location_type',
               existing_type=sa.VARCHAR(length=50),
               comment='位置类型 (country/province/city/site/datacenter)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'parent_id',
               existing_type=sa.VARCHAR(length=50),
               comment='上级位置ID',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'region',
               existing_type=sa.VARCHAR(length=50),
               comment='区域 (华北/华东/华南)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'manager_user_id',
               existing_type=sa.UUID(),
               comment='负责人ID',
               existing_nullable=True)
    op.create_index(op.f('ix_mdm_locations_code'), 'mdm_locations', ['code'], unique=True)
    op.alter_column('mdm_metric_definitions', 'metric_code',
               existing_type=sa.VARCHAR(length=100),
               comment='指标唯一编码 (如 DORA_MTTR_PROD)',
               existing_nullable=False)
    op.alter_column('mdm_metric_definitions', 'metric_name',
               existing_type=sa.VARCHAR(length=200),
               comment='指标展示名称 (如 生产环境平均修复时间)',
               existing_nullable=False)
    op.alter_column('mdm_metric_definitions', 'domain',
               existing_type=sa.VARCHAR(length=50),
               comment='所属业务域 (DEVOPS/FINANCE/OPERATION)',
               existing_nullable=False)
    op.alter_column('mdm_metric_definitions', 'metric_type',
               existing_type=sa.VARCHAR(length=50),
               comment='指标类型 (ATOMIC:原子指标 / DERIVED:派生指标 / COMPOSITE:复合指标)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'calculation_logic',
               existing_type=sa.TEXT(),
               comment='计算逻辑说明 (SQL公式或自然语言描述)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'unit',
               existing_type=sa.VARCHAR(length=50),
               comment='度量单位 (%, ms, Hours, Count, CNY)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'aggregate_type',
               existing_type=sa.VARCHAR(length=20),
               comment='聚合方式 (SUM, AVG, COUNT, MAX, MIN)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'source_model',
               existing_type=sa.VARCHAR(length=200),
               comment='来源数据模型 (关联 dbt 模型或数据库表名)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'dimension_scope',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='允许下钻的维度列表 (JSON List, 如 ["dept", "application", "priority"])',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'is_standard',
               existing_type=sa.BOOLEAN(),
               comment='是否集团标准指标 (True: 锁定口径, 不允许随意修改)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'business_owner_id',
               existing_type=sa.UUID(),
               comment='指标业务负责人ID (PDM/Data Owner)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'time_grain',
               existing_type=sa.VARCHAR(length=50),
               comment='统计时间粒度 (Daily, Weekly, Monthly)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'update_cycle',
               existing_type=sa.VARCHAR(length=50),
               comment='数据刷新周期 (Realtime, T+1, Hourly)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment='生命周期状态 (DRAFT:草稿 / RELEASED:已发布 / DEPRECATED:已废弃)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否启用 (逻辑删除标志)',
               existing_nullable=True)
    op.create_foreign_key(None, 'mdm_metric_definitions', 'mdm_identities', ['business_owner_id'], ['global_user_id'])
    op.alter_column('mdm_organizations', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_organizations_id_seq'::regclass)"))
    op.alter_column('mdm_organizations', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment='组织唯一标识 (HR系统同步)',
               existing_nullable=False)
    op.alter_column('mdm_organizations', 'org_name',
               existing_type=sa.VARCHAR(length=200),
               comment='组织名称',
               existing_nullable=False)
    op.alter_column('mdm_organizations', 'org_level',
               existing_type=sa.INTEGER(),
               comment='组织层级 (1=公司, 2=部门, 3=团队)',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'parent_org_id',
               existing_type=sa.VARCHAR(length=100),
               comment='上级组织ID',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'manager_user_id',
               existing_type=sa.UUID(),
               comment='部门负责人用户ID',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'cost_center',
               existing_type=sa.VARCHAR(length=100),
               comment='成本中心编码',
               existing_nullable=True)
    op.add_column('mdm_product', sa.Column('sync_version', sa.Integer(), nullable=True))
    op.execute("UPDATE mdm_product SET sync_version = 1 WHERE sync_version IS NULL")
    op.alter_column('mdm_product', 'sync_version', nullable=False)
    op.add_column('mdm_product', sa.Column('effective_from', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_product', sa.Column('effective_to', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_product', sa.Column('is_current', sa.Boolean(), nullable=True))
    op.add_column('mdm_product', sa.Column('is_deleted', sa.Boolean(), nullable=True))
    op.alter_column('mdm_product', 'product_id',
               existing_type=sa.VARCHAR(length=100),
               comment='产品唯一标识',
               existing_nullable=False)
    op.alter_column('mdm_product', 'product_code',
               existing_type=sa.VARCHAR(length=25),
               comment='产品编码',
               existing_nullable=False)
    op.alter_column('mdm_product', 'product_name',
               existing_type=sa.VARCHAR(length=255),
               comment='产品名称',
               existing_nullable=False)
    op.alter_column('mdm_product', 'product_description',
               existing_type=sa.TEXT(),
               comment='产品描述',
               existing_nullable=False)
    op.alter_column('mdm_product', 'category',
               existing_type=sa.VARCHAR(length=100),
               comment='产品分类 (平台/应用/组件)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'version_schema',
               existing_type=sa.VARCHAR(length=50),
               comment='版本命名规则 (SemVer/CalVer)',
               existing_nullable=False)
    op.alter_column('mdm_product', 'specification',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='产品规格配置 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'runtime_env',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='运行环境配置 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'checksum',
               existing_type=sa.VARCHAR(length=255),
               comment='最新版本校验码',
               existing_nullable=True)
    op.alter_column('mdm_product', 'lifecycle_status',
               existing_type=sa.VARCHAR(length=50),
               comment='生命周期状态 (Active/Deprecated/EOL)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'repo_url',
               existing_type=sa.VARCHAR(length=255),
               comment='主代码仓库URL',
               existing_nullable=True)
    op.alter_column('mdm_product', 'artifact_path',
               existing_type=sa.VARCHAR(length=255),
               comment='制品存储路径',
               existing_nullable=True)
    op.alter_column('mdm_product', 'owner_team_id',
               existing_type=sa.VARCHAR(length=100),
               comment='负责团队ID',
               existing_nullable=True)
    op.alter_column('mdm_product', 'product_manager_id',
               existing_type=sa.UUID(),
               comment='产品经理ID',
               existing_nullable=True)
    op.create_index(op.f('ix_mdm_product_is_current'), 'mdm_product', ['is_current'], unique=False)
    op.add_column('mdm_projects', sa.Column('location_id', sa.String(length=50), nullable=True, comment='项目所属/实施地点ID'))
    op.alter_column('mdm_projects', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment='项目唯一标识',
               existing_nullable=False)
    op.alter_column('mdm_projects', 'project_name',
               existing_type=sa.VARCHAR(length=200),
               comment='项目名称',
               existing_nullable=False)
    op.alter_column('mdm_projects', 'project_type',
               existing_type=sa.VARCHAR(length=50),
               comment='项目类型 (研发项目/运维项目/POC)',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment='项目状态 (PLAN/ACTIVE/SUSPENDED/CLOSED)',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'pm_user_id',
               existing_type=sa.UUID(),
               comment='项目经理ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment='负责部门ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'plan_start_date',
               existing_type=sa.DATE(),
               comment='计划开始日期',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'plan_end_date',
               existing_type=sa.DATE(),
               comment='计划结束日期',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'actual_start_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='实际开始时间',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'actual_end_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='实际结束时间',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'external_id',
               existing_type=sa.VARCHAR(length=100),
               comment='外部系统项目ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'system_code',
               existing_type=sa.VARCHAR(length=50),
               comment='数据来源系统',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'budget_code',
               existing_type=sa.VARCHAR(length=100),
               comment='预算编码',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'budget_type',
               existing_type=sa.VARCHAR(length=50),
               comment='预算类型 (CAPEX/OPEX)',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'lead_repo_id',
               existing_type=sa.INTEGER(),
               comment='主代码仓库ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'description',
               existing_type=sa.TEXT(),
               comment='项目描述',
               existing_nullable=True)
    op.create_foreign_key(None, 'mdm_projects', 'mdm_locations', ['location_id'], ['location_id'])
    op.alter_column('mdm_purchase_contracts', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_purchase_contracts', 'contract_no',
               existing_type=sa.VARCHAR(length=100),
               comment='合同编号',
               existing_nullable=False)
    op.alter_column('mdm_purchase_contracts', 'title',
               existing_type=sa.VARCHAR(length=255),
               comment='合同标题',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'vendor_name',
               existing_type=sa.VARCHAR(length=255),
               comment='供应商名称',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'vendor_id',
               existing_type=sa.VARCHAR(length=100),
               comment='供应商ID',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'total_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='合同总额',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment='币种',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'start_date',
               existing_type=sa.DATE(),
               comment='合同开始日期',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'end_date',
               existing_type=sa.DATE(),
               comment='合同结束日期',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'cost_code_id',
               existing_type=sa.INTEGER(),
               comment='成本科目ID',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'capex_opex_flag',
               existing_type=sa.VARCHAR(length=10),
               comment='CAPEX/OPEX标志',
               existing_nullable=True)
    op.alter_column('mdm_rel_project_product', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_rel_project_product', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment='项目ID',
               existing_nullable=False)
    op.alter_column('mdm_rel_project_product', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment='所属组织ID',
               existing_nullable=False)
    op.alter_column('mdm_rel_project_product', 'product_id',
               existing_type=sa.VARCHAR(length=100),
               comment='产品ID',
               existing_nullable=False)
    op.alter_column('mdm_rel_project_product', 'relation_type',
               existing_type=sa.VARCHAR(length=50),
               comment='关联类型 (PRIMARY/SECONDARY)',
               existing_nullable=True)
    op.alter_column('mdm_rel_project_product', 'allocation_ratio',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='工作量分配比例',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_revenue_contracts_id_seq'::regclass)"))
    op.alter_column('mdm_revenue_contracts', 'contract_no',
               existing_type=sa.VARCHAR(length=100),
               comment='合同编号',
               existing_nullable=False)
    op.alter_column('mdm_revenue_contracts', 'title',
               existing_type=sa.VARCHAR(length=255),
               comment='合同标题',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'client_name',
               existing_type=sa.VARCHAR(length=255),
               comment='客户名称',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'total_value',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='合同总额',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment='币种',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'sign_date',
               existing_type=sa.DATE(),
               comment='签约日期',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'product_id',
               existing_type=sa.VARCHAR(length=100),
               comment='关联产品ID',
               existing_nullable=True)
    op.alter_column('mdm_service_project_mapping', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_service_project_mapping', 'service_id',
               existing_type=sa.INTEGER(),
               comment='服务ID',
               existing_nullable=False)
    op.alter_column('mdm_service_project_mapping', 'source',
               existing_type=sa.VARCHAR(length=50),
               comment='项目来源系统 (gitlab/jira)',
               existing_nullable=True)
    op.alter_column('mdm_service_project_mapping', 'project_id',
               existing_type=sa.INTEGER(),
               comment='外部项目ID',
               existing_nullable=True)
    op.add_column('mdm_services', sa.Column('sync_version', sa.Integer(), nullable=True))
    op.execute("UPDATE mdm_services SET sync_version = 1 WHERE sync_version IS NULL")
    op.alter_column('mdm_services', 'sync_version', nullable=False)
    op.add_column('mdm_services', sa.Column('effective_from', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_services', sa.Column('effective_to', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_services', sa.Column('is_current', sa.Boolean(), nullable=True))
    op.add_column('mdm_services', sa.Column('is_deleted', sa.Boolean(), nullable=True))
    op.alter_column('mdm_services', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_services_id_seq'::regclass)"))
    op.alter_column('mdm_services', 'name',
               existing_type=sa.VARCHAR(length=200),
               comment='服务名称',
               existing_nullable=False)
    op.alter_column('mdm_services', 'tier',
               existing_type=sa.VARCHAR(length=20),
               comment='服务级别 (T0/T1/T2/T3)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment='负责组织ID',
               existing_nullable=True)
    op.alter_column('mdm_services', 'description',
               existing_type=sa.TEXT(),
               comment='服务描述',
               existing_nullable=True)
    op.alter_column('mdm_services', 'system_id',
               existing_type=sa.INTEGER(),
               comment='所属业务系统ID',
               existing_nullable=True)
    op.alter_column('mdm_services', 'lifecycle',
               existing_type=sa.VARCHAR(length=20),
               comment='生命周期 (experimental/production/deprecated)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'component_type',
               existing_type=sa.VARCHAR(length=20),
               comment='组件类型 (service/library/website/tool)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'tags',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='标签列表 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'links',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='相关链接 (JSON)',
               existing_nullable=True)
    op.create_index(op.f('ix_mdm_services_is_current'), 'mdm_services', ['is_current'], unique=False)
    op.create_foreign_key(None, 'mdm_services', 'mdm_business_systems', ['system_id'], ['id'])
    op.alter_column('mdm_slo_definitions', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_slo_definitions', 'service_id',
               existing_type=sa.INTEGER(),
               comment='关联服务ID',
               existing_nullable=False)
    op.alter_column('mdm_slo_definitions', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment='SLO 名称',
               existing_nullable=False)
    op.alter_column('mdm_slo_definitions', 'indicator_type',
               existing_type=sa.VARCHAR(length=50),
               comment='指标类型 (Availability/Latency/Throughput)',
               existing_nullable=True)
    op.alter_column('mdm_slo_definitions', 'target_value',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='目标值',
               existing_nullable=True)
    op.alter_column('mdm_slo_definitions', 'metric_unit',
               existing_type=sa.VARCHAR(length=20),
               comment='度量单位 (%/ms)',
               existing_nullable=True)
    op.alter_column('mdm_slo_definitions', 'time_window',
               existing_type=sa.VARCHAR(length=20),
               comment='统计窗口期 (28d/7d)',
               existing_nullable=True)
    op.add_column('mdm_systems_registry', sa.Column('env_tag', sa.String(length=20), nullable=True, comment='环境标签 (PROD/Stage/Test)'))
    op.add_column('mdm_systems_registry', sa.Column('credential_key', sa.String(length=100), nullable=True, comment='凭证引用Key (指向Vault或Env Var)'))
    op.add_column('mdm_systems_registry', sa.Column('plugin_config', sa.JSON(), nullable=True, comment='插件特定配置 (JSON, 如过滤规则、超时设置)'))
    op.add_column('mdm_systems_registry', sa.Column('enabled_plugins', sa.String(length=255), nullable=True, comment='启用的采集插件列表 (逗号分隔)'))
    op.add_column('mdm_systems_registry', sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True, comment='最后一次数据同步时间'))
    op.add_column('mdm_systems_registry', sa.Column('sync_version', sa.Integer(), nullable=True))
    op.execute("UPDATE mdm_systems_registry SET sync_version = 1 WHERE sync_version IS NULL")
    op.alter_column('mdm_systems_registry', 'sync_version', nullable=False)
    op.add_column('mdm_systems_registry', sa.Column('effective_from', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_systems_registry', sa.Column('effective_to', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_systems_registry', sa.Column('is_current', sa.Boolean(), nullable=True))
    op.add_column('mdm_systems_registry', sa.Column('is_deleted', sa.Boolean(), nullable=True))
    op.alter_column('mdm_systems_registry', 'system_code',
               existing_type=sa.VARCHAR(length=50),
               comment='系统唯一标准代号 (如 gitlab-corp)',
               existing_nullable=False)
    op.alter_column('mdm_systems_registry', 'system_name',
               existing_type=sa.VARCHAR(length=100),
               comment='系统显示名称',
               existing_nullable=False)
    op.alter_column('mdm_systems_registry', 'system_type',
               existing_type=sa.VARCHAR(length=50),
               comment='工具类型 (VCS/TICKET/CI/SONAR/K8S)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'base_url',
               existing_type=sa.VARCHAR(length=255),
               comment='API 基础地址 (Base URL)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'api_version',
               existing_type=sa.VARCHAR(length=20),
               comment='API 接口版本 (如 v4, api/v2)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'auth_type',
               existing_type=sa.VARCHAR(length=50),
               comment='认证方式 (OAuth2/Token/Basic)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'sync_method',
               existing_type=sa.VARCHAR(length=50),
               comment='同步方式 (CDC/Polling/Webhook)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'update_cycle',
               existing_type=sa.VARCHAR(length=50),
               comment='更新频率 (Realtime/Hourly/Daily)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'data_sensitivity',
               existing_type=sa.VARCHAR(length=20),
               comment='数据敏感级 (L1-L4)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'sla_level',
               existing_type=sa.VARCHAR(length=20),
               comment='服务等级 (P0-Critical / P1-High)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'technical_owner_id',
               existing_type=sa.UUID(),
               comment='技术负责人ID',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment='是否启用采集',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'last_heartbeat',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='最后连通性检查时间',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'remarks',
               existing_type=sa.TEXT(),
               comment='备注说明',
               existing_nullable=True)
    op.create_index(op.f('ix_mdm_systems_registry_is_current'), 'mdm_systems_registry', ['is_current'], unique=False)
    op.create_foreign_key(None, 'mdm_systems_registry', 'mdm_identities', ['technical_owner_id'], ['global_user_id'])
    op.add_column('mdm_traceability_links', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_traceability_links', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('mdm_traceability_links', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_traceability_links', 'source_system',
               existing_type=sa.VARCHAR(length=50),
               comment='源系统 (jira/gitlab)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'source_type',
               existing_type=sa.VARCHAR(length=50),
               comment='源实体类型 (requirement/story)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'source_id',
               existing_type=sa.VARCHAR(length=100),
               comment='源实体ID',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'target_system',
               existing_type=sa.VARCHAR(length=50),
               comment='目标系统 (gitlab/jenkins)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'target_type',
               existing_type=sa.VARCHAR(length=50),
               comment='目标实体类型 (commit/merge_request/build)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'target_id',
               existing_type=sa.VARCHAR(length=100),
               comment='目标实体ID',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'link_type',
               existing_type=sa.VARCHAR(length=50),
               comment='链路类型 (implements/tests/deploys)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'raw_data',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='原始关联数据 (JSON)',
               existing_nullable=True)
    op.create_index(op.f('ix_mdm_traceability_links_source_id'), 'mdm_traceability_links', ['source_id'], unique=False)
    op.create_index(op.f('ix_mdm_traceability_links_target_id'), 'mdm_traceability_links', ['target_id'], unique=False)
    op.add_column('mdm_vendor', sa.Column('name', sa.String(length=200), nullable=False, comment='供应商全称'))
    op.add_column('mdm_vendor', sa.Column('short_name', sa.String(length=100), nullable=True, comment='供应商简称'))
    op.add_column('mdm_vendor', sa.Column('category', sa.String(length=50), nullable=True, comment='供应商类别 (人力外包/软件许可/云服务/硬件)'))
    op.add_column('mdm_vendor', sa.Column('status', sa.String(length=20), nullable=True, comment='合作状态 (ACTIVE/BLACKLIST/INACTIVE)'))
    op.add_column('mdm_vendor', sa.Column('tax_id', sa.String(length=50), nullable=True, comment='统一社会信用代码/税号'))
    op.add_column('mdm_vendor', sa.Column('payment_terms', sa.String(length=100), nullable=True, comment='默认账期 (e.g. Net 30, Net 60)'))
    op.add_column('mdm_vendor', sa.Column('currency', sa.String(length=10), nullable=True, comment='默认结算币种'))
    op.add_column('mdm_vendor', sa.Column('contact_person', sa.String(length=100), nullable=True, comment='主要联系人'))
    op.add_column('mdm_vendor', sa.Column('contact_email', sa.String(length=100), nullable=True, comment='联系邮箱'))
    op.add_column('mdm_vendor', sa.Column('contact_phone', sa.String(length=50), nullable=True, comment='联系电话'))
    op.add_column('mdm_vendor', sa.Column('rating', sa.Float(), nullable=True, comment='供应商绩效评分 (0-5)'))
    op.add_column('mdm_vendor', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('mdm_vendor', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('mdm_vendor', 'vendor_code',
               existing_type=sa.VARCHAR(length=50),
               comment='供应商唯一编码',
               existing_nullable=False)
    op.alter_column('rbac_permissions', 'code',
               existing_type=sa.VARCHAR(length=100),
               comment='权限代码 (如 ticket:create)',
               existing_nullable=False)
    op.alter_column('rbac_permissions', 'category',
               existing_type=sa.VARCHAR(length=50),
               comment='权限分类 (ticket/project/admin)',
               existing_nullable=True)
    op.alter_column('rbac_permissions', 'description',
               existing_type=sa.VARCHAR(length=255),
               comment='权限描述',
               existing_nullable=True)
    op.alter_column('rbac_roles', 'id',
               existing_type=sa.INTEGER(),
               comment='角色ID',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('rbac_roles_id_seq'::regclass)"))
    op.alter_column('rbac_roles', 'code',
               existing_type=sa.VARCHAR(length=50),
               comment='角色代码 (admin/pm/dev/viewer)',
               existing_nullable=False)
    op.alter_column('rbac_roles', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment='角色显示名称',
               existing_nullable=False)
    op.alter_column('rbac_roles', 'description',
               existing_type=sa.VARCHAR(length=255),
               comment='角色描述',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('satisfaction_records', 'user_email',
               existing_type=sa.VARCHAR(length=255),
               comment='受访用户邮箱',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'score',
               existing_type=sa.INTEGER(),
               comment='满意度评分 (1-5, 5为最高)',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'date',
               existing_type=sa.DATE(),
               comment='调查日期',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'tags',
               existing_type=sa.VARCHAR(length=255),
               comment='标签 (如 工具/流程/协作)',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'comment',
               existing_type=sa.VARCHAR(length=500),
               comment='开放式反馈评语',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('stg_mdm_resource_costs', 'service_id',
               existing_type=sa.INTEGER(),
               comment='关联服务ID',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'cost_code_id',
               existing_type=sa.INTEGER(),
               comment='成本科目ID',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'purchase_contract_id',
               existing_type=sa.INTEGER(),
               comment='采购合同ID',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'period',
               existing_type=sa.VARCHAR(length=20),
               comment='费用周期 (YYYY-MM)',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='费用金额',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment='币种',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'cost_type',
               existing_type=sa.VARCHAR(length=50),
               comment='成本类型 (云资源/人力/软件)',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'cost_item',
               existing_type=sa.VARCHAR(length=200),
               comment='成本项目名称',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'vendor_name',
               existing_type=sa.VARCHAR(length=200),
               comment='供应商名称',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'capex_opex_flag',
               existing_type=sa.VARCHAR(length=10),
               comment='CAPEX/OPEX标志',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'source_system',
               existing_type=sa.VARCHAR(length=100),
               comment='数据来源系统',
               existing_nullable=True)
    op.add_column('stg_raw_data', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('stg_raw_data', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('stg_raw_data', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('stg_raw_data', 'source',
               existing_type=sa.VARCHAR(length=50),
               comment='数据来源系统 (gitlab/jira/sonar)',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'entity_type',
               existing_type=sa.VARCHAR(length=50),
               comment='实体类型 (project/issue/pipeline)',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'external_id',
               existing_type=sa.VARCHAR(length=100),
               comment='外部系统记录ID',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'payload',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment='原始 JSON 数据负载',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'schema_version',
               existing_type=sa.VARCHAR(length=20),
               comment='Payload 结构版本',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'collected_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='采集时间',
               existing_nullable=True)
    op.create_index(op.f('ix_stg_raw_data_external_id'), 'stg_raw_data', ['external_id'], unique=False)
    op.alter_column('sys_role_permissions', 'role_id',
               existing_type=sa.INTEGER(),
               comment='角色ID',
               existing_nullable=False)
    op.alter_column('sys_role_permissions', 'permission_code',
               existing_type=sa.VARCHAR(length=100),
               comment='权限代码',
               existing_nullable=False)
    op.alter_column('sys_sync_logs', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('sys_sync_logs', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment='关联项目ID',
               existing_nullable=True)
    op.alter_column('sys_sync_logs', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment='同步状态 (SUCCESS/FAILED/RUNNING)',
               existing_nullable=True)
    op.alter_column('sys_sync_logs', 'message',
               existing_type=sa.TEXT(),
               comment='同步结果信息',
               existing_nullable=True)
    op.alter_column('sys_team_members', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('sys_team_members', 'team_id',
               existing_type=sa.INTEGER(),
               comment='团队ID',
               existing_nullable=False)
    op.alter_column('sys_team_members', 'user_id',
               existing_type=sa.UUID(),
               comment='成员用户ID',
               existing_nullable=False)
    op.alter_column('sys_team_members', 'role_code',
               existing_type=sa.VARCHAR(length=50),
               comment='团队角色 (LEADER/MEMBER/CONSULTANT)',
               existing_nullable=True)
    op.alter_column('sys_team_members', 'allocation_ratio',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='工作量分配比例 (0.0-1.0)',
               existing_nullable=True)
    op.add_column('sys_teams', sa.Column('sync_version', sa.Integer(), nullable=True))
    op.execute("UPDATE sys_teams SET sync_version = 1 WHERE sync_version IS NULL")
    op.alter_column('sys_teams', 'sync_version', nullable=False)
    op.add_column('sys_teams', sa.Column('effective_from', sa.DateTime(timezone=True), nullable=True))
    op.add_column('sys_teams', sa.Column('effective_to', sa.DateTime(timezone=True), nullable=True))
    op.add_column('sys_teams', sa.Column('is_current', sa.Boolean(), nullable=True))
    op.add_column('sys_teams', sa.Column('is_deleted', sa.Boolean(), nullable=True))
    op.alter_column('sys_teams', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('sys_teams_id_seq'::regclass)"))
    op.alter_column('sys_teams', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment='团队名称',
               existing_nullable=False)
    op.alter_column('sys_teams', 'team_code',
               existing_type=sa.VARCHAR(length=50),
               comment='团队代码',
               existing_nullable=True)
    op.alter_column('sys_teams', 'description',
               existing_type=sa.TEXT(),
               comment='团队描述',
               existing_nullable=True)
    op.alter_column('sys_teams', 'parent_id',
               existing_type=sa.INTEGER(),
               comment='上级团队ID',
               existing_nullable=True)
    op.alter_column('sys_teams', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment='所属组织ID',
               existing_nullable=True)
    op.alter_column('sys_teams', 'leader_id',
               existing_type=sa.UUID(),
               comment='团队负责人ID',
               existing_nullable=True)
    op.create_index(op.f('ix_sys_teams_is_current'), 'sys_teams', ['is_current'], unique=False)
    op.alter_column('sys_user_credentials', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('sys_user_credentials', 'user_id',
               existing_type=sa.UUID(),
               comment='用户ID',
               existing_nullable=True)
    op.alter_column('sys_user_credentials', 'password_hash',
               existing_type=sa.VARCHAR(length=255),
               comment='密码哈希值',
               existing_nullable=False)
    op.alter_column('sys_user_credentials', 'last_login_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='最后登录时间',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'id',
               existing_type=sa.INTEGER(),
               comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('sys_user_oauth_tokens', 'user_id',
               existing_type=sa.VARCHAR(length=100),
               comment='用户标识',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'provider',
               existing_type=sa.VARCHAR(length=50),
               comment='OAuth 提供商 (gitlab/github/azure)',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'access_token',
               existing_type=sa.VARCHAR(length=1024),
               comment='访问令牌 (加密存储)',
               existing_nullable=False)
    op.alter_column('sys_user_oauth_tokens', 'refresh_token',
               existing_type=sa.VARCHAR(length=1024),
               comment='刷新令牌',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'token_type',
               existing_type=sa.VARCHAR(length=50),
               comment='令牌类型 (Bearer)',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'expires_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='过期时间',
               existing_nullable=True)
    op.alter_column('sys_user_roles', 'user_id',
               existing_type=sa.UUID(),
               comment='用户ID',
               existing_nullable=False)
    op.alter_column('sys_user_roles', 'role_id',
               existing_type=sa.INTEGER(),
               comment='角色ID',
               existing_nullable=False)
    op.drop_constraint('sys_user_roles_role_id_fkey', 'sys_user_roles', type_='foreignkey')
    op.create_foreign_key(None, 'sys_user_roles', 'sys_role', ['role_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'sys_user_roles', type_='foreignkey')
    op.create_foreign_key('sys_user_roles_role_id_fkey', 'sys_user_roles', 'rbac_roles', ['role_id'], ['id'])
    op.alter_column('sys_user_roles', 'role_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='角色ID',
               existing_nullable=False)
    op.alter_column('sys_user_roles', 'user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='用户ID',
               existing_nullable=False)
    op.alter_column('sys_user_oauth_tokens', 'expires_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='过期时间',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'token_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='令牌类型 (Bearer)',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'refresh_token',
               existing_type=sa.VARCHAR(length=1024),
               comment=None,
               existing_comment='刷新令牌',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'access_token',
               existing_type=sa.VARCHAR(length=1024),
               comment=None,
               existing_comment='访问令牌 (加密存储)',
               existing_nullable=False)
    op.alter_column('sys_user_oauth_tokens', 'provider',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='OAuth 提供商 (gitlab/github/azure)',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'user_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='用户标识',
               existing_nullable=True)
    op.alter_column('sys_user_oauth_tokens', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('sys_user_credentials', 'last_login_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='最后登录时间',
               existing_nullable=True)
    op.alter_column('sys_user_credentials', 'password_hash',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='密码哈希值',
               existing_nullable=False)
    op.alter_column('sys_user_credentials', 'user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='用户ID',
               existing_nullable=True)
    op.alter_column('sys_user_credentials', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_index(op.f('ix_sys_teams_is_current'), table_name='sys_teams')
    op.alter_column('sys_teams', 'leader_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='团队负责人ID',
               existing_nullable=True)
    op.alter_column('sys_teams', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='所属组织ID',
               existing_nullable=True)
    op.alter_column('sys_teams', 'parent_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='上级团队ID',
               existing_nullable=True)
    op.alter_column('sys_teams', 'description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='团队描述',
               existing_nullable=True)
    op.alter_column('sys_teams', 'team_code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='团队代码',
               existing_nullable=True)
    op.alter_column('sys_teams', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='团队名称',
               existing_nullable=False)
    op.alter_column('sys_teams', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('sys_teams_id_seq'::regclass)"))
    op.drop_column('sys_teams', 'is_deleted')
    op.drop_column('sys_teams', 'is_current')
    op.drop_column('sys_teams', 'effective_to')
    op.drop_column('sys_teams', 'effective_from')
    op.drop_column('sys_teams', 'sync_version')
    op.alter_column('sys_team_members', 'allocation_ratio',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='工作量分配比例 (0.0-1.0)',
               existing_nullable=True)
    op.alter_column('sys_team_members', 'role_code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='团队角色 (LEADER/MEMBER/CONSULTANT)',
               existing_nullable=True)
    op.alter_column('sys_team_members', 'user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='成员用户ID',
               existing_nullable=False)
    op.alter_column('sys_team_members', 'team_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='团队ID',
               existing_nullable=False)
    op.alter_column('sys_team_members', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('sys_sync_logs', 'message',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='同步结果信息',
               existing_nullable=True)
    op.alter_column('sys_sync_logs', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='同步状态 (SUCCESS/FAILED/RUNNING)',
               existing_nullable=True)
    op.alter_column('sys_sync_logs', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='关联项目ID',
               existing_nullable=True)
    op.alter_column('sys_sync_logs', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('sys_role_permissions', 'permission_code',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='权限代码',
               existing_nullable=False)
    op.alter_column('sys_role_permissions', 'role_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='角色ID',
               existing_nullable=False)
    op.drop_index(op.f('ix_stg_raw_data_external_id'), table_name='stg_raw_data')
    op.alter_column('stg_raw_data', 'collected_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='采集时间',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'schema_version',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='Payload 结构版本',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'payload',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='原始 JSON 数据负载',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'external_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='外部系统记录ID',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'entity_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='实体类型 (project/issue/pipeline)',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'source',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='数据来源系统 (gitlab/jira/sonar)',
               existing_nullable=True)
    op.alter_column('stg_raw_data', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('stg_raw_data', 'updated_at')
    op.drop_column('stg_raw_data', 'created_at')
    op.alter_column('stg_mdm_resource_costs', 'source_system',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='数据来源系统',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'capex_opex_flag',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='CAPEX/OPEX标志',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'vendor_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='供应商名称',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'cost_item',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='成本项目名称',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'cost_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='成本类型 (云资源/人力/软件)',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='币种',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='费用金额',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'period',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='费用周期 (YYYY-MM)',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'purchase_contract_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='采购合同ID',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'cost_code_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='成本科目ID',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'service_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联服务ID',
               existing_nullable=True)
    op.alter_column('stg_mdm_resource_costs', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('satisfaction_records', 'comment',
               existing_type=sa.VARCHAR(length=500),
               comment=None,
               existing_comment='开放式反馈评语',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'tags',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='标签 (如 工具/流程/协作)',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='调查日期',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'score',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='满意度评分 (1-5, 5为最高)',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'user_email',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='受访用户邮箱',
               existing_nullable=True)
    op.alter_column('satisfaction_records', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('rbac_roles', 'description',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='角色描述',
               existing_nullable=True)
    op.alter_column('rbac_roles', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='角色显示名称',
               existing_nullable=False)
    op.alter_column('rbac_roles', 'code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='角色代码 (admin/pm/dev/viewer)',
               existing_nullable=False)
    op.alter_column('rbac_roles', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='角色ID',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('rbac_roles_id_seq'::regclass)"))
    op.alter_column('rbac_permissions', 'description',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='权限描述',
               existing_nullable=True)
    op.alter_column('rbac_permissions', 'category',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='权限分类 (ticket/project/admin)',
               existing_nullable=True)
    op.alter_column('rbac_permissions', 'code',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='权限代码 (如 ticket:create)',
               existing_nullable=False)
    op.alter_column('mdm_vendor', 'vendor_code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='供应商唯一编码',
               existing_nullable=False)
    op.drop_column('mdm_vendor', 'updated_at')
    op.drop_column('mdm_vendor', 'created_at')
    op.drop_column('mdm_vendor', 'rating')
    op.drop_column('mdm_vendor', 'contact_phone')
    op.drop_column('mdm_vendor', 'contact_email')
    op.drop_column('mdm_vendor', 'contact_person')
    op.drop_column('mdm_vendor', 'currency')
    op.drop_column('mdm_vendor', 'payment_terms')
    op.drop_column('mdm_vendor', 'tax_id')
    op.drop_column('mdm_vendor', 'status')
    op.drop_column('mdm_vendor', 'category')
    op.drop_column('mdm_vendor', 'short_name')
    op.drop_column('mdm_vendor', 'name')
    op.drop_index(op.f('ix_mdm_traceability_links_target_id'), table_name='mdm_traceability_links')
    op.drop_index(op.f('ix_mdm_traceability_links_source_id'), table_name='mdm_traceability_links')
    op.alter_column('mdm_traceability_links', 'raw_data',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='原始关联数据 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'link_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='链路类型 (implements/tests/deploys)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'target_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='目标实体ID',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'target_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='目标实体类型 (commit/merge_request/build)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'target_system',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='目标系统 (gitlab/jenkins)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'source_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='源实体ID',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'source_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='源实体类型 (requirement/story)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'source_system',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='源系统 (jira/gitlab)',
               existing_nullable=True)
    op.alter_column('mdm_traceability_links', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('mdm_traceability_links', 'updated_at')
    op.drop_column('mdm_traceability_links', 'created_at')
    op.drop_constraint(None, 'mdm_systems_registry', type_='foreignkey')
    op.drop_index(op.f('ix_mdm_systems_registry_is_current'), table_name='mdm_systems_registry')
    op.alter_column('mdm_systems_registry', 'remarks',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='备注说明',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'last_heartbeat',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='最后连通性检查时间',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否启用采集',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'technical_owner_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='技术负责人ID',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'sla_level',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='服务等级 (P0-Critical / P1-High)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'data_sensitivity',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='数据敏感级 (L1-L4)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'update_cycle',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新频率 (Realtime/Hourly/Daily)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'sync_method',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='同步方式 (CDC/Polling/Webhook)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'auth_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='认证方式 (OAuth2/Token/Basic)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'api_version',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='API 接口版本 (如 v4, api/v2)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'base_url',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='API 基础地址 (Base URL)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'system_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='工具类型 (VCS/TICKET/CI/SONAR/K8S)',
               existing_nullable=True)
    op.alter_column('mdm_systems_registry', 'system_name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='系统显示名称',
               existing_nullable=False)
    op.alter_column('mdm_systems_registry', 'system_code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='系统唯一标准代号 (如 gitlab-corp)',
               existing_nullable=False)
    op.drop_column('mdm_systems_registry', 'is_deleted')
    op.drop_column('mdm_systems_registry', 'is_current')
    op.drop_column('mdm_systems_registry', 'effective_to')
    op.drop_column('mdm_systems_registry', 'effective_from')
    op.drop_column('mdm_systems_registry', 'sync_version')
    op.drop_column('mdm_systems_registry', 'last_sync_at')
    op.drop_column('mdm_systems_registry', 'enabled_plugins')
    op.drop_column('mdm_systems_registry', 'plugin_config')
    op.drop_column('mdm_systems_registry', 'credential_key')
    op.drop_column('mdm_systems_registry', 'env_tag')
    op.alter_column('mdm_slo_definitions', 'time_window',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='统计窗口期 (28d/7d)',
               existing_nullable=True)
    op.alter_column('mdm_slo_definitions', 'metric_unit',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='度量单位 (%/ms)',
               existing_nullable=True)
    op.alter_column('mdm_slo_definitions', 'target_value',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='目标值',
               existing_nullable=True)
    op.alter_column('mdm_slo_definitions', 'indicator_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='指标类型 (Availability/Latency/Throughput)',
               existing_nullable=True)
    op.alter_column('mdm_slo_definitions', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='SLO 名称',
               existing_nullable=False)
    op.alter_column('mdm_slo_definitions', 'service_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联服务ID',
               existing_nullable=False)
    op.alter_column('mdm_slo_definitions', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_constraint(None, 'mdm_services', type_='foreignkey')
    op.drop_index(op.f('ix_mdm_services_is_current'), table_name='mdm_services')
    op.alter_column('mdm_services', 'links',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='相关链接 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'tags',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='标签列表 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'component_type',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='组件类型 (service/library/website/tool)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'lifecycle',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='生命周期 (experimental/production/deprecated)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'system_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='所属业务系统ID',
               existing_nullable=True)
    op.alter_column('mdm_services', 'description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='服务描述',
               existing_nullable=True)
    op.alter_column('mdm_services', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='负责组织ID',
               existing_nullable=True)
    op.alter_column('mdm_services', 'tier',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='服务级别 (T0/T1/T2/T3)',
               existing_nullable=True)
    op.alter_column('mdm_services', 'name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='服务名称',
               existing_nullable=False)
    op.alter_column('mdm_services', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_services_id_seq'::regclass)"))
    op.drop_column('mdm_services', 'is_deleted')
    op.drop_column('mdm_services', 'is_current')
    op.drop_column('mdm_services', 'effective_to')
    op.drop_column('mdm_services', 'effective_from')
    op.drop_column('mdm_services', 'sync_version')
    op.alter_column('mdm_service_project_mapping', 'project_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='外部项目ID',
               existing_nullable=True)
    op.alter_column('mdm_service_project_mapping', 'source',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='项目来源系统 (gitlab/jira)',
               existing_nullable=True)
    op.alter_column('mdm_service_project_mapping', 'service_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='服务ID',
               existing_nullable=False)
    op.alter_column('mdm_service_project_mapping', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_revenue_contracts', 'product_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='关联产品ID',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'sign_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='签约日期',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='币种',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'total_value',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='合同总额',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'client_name',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='客户名称',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'title',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='合同标题',
               existing_nullable=True)
    op.alter_column('mdm_revenue_contracts', 'contract_no',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='合同编号',
               existing_nullable=False)
    op.alter_column('mdm_revenue_contracts', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_revenue_contracts_id_seq'::regclass)"))
    op.alter_column('mdm_rel_project_product', 'allocation_ratio',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='工作量分配比例',
               existing_nullable=True)
    op.alter_column('mdm_rel_project_product', 'relation_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='关联类型 (PRIMARY/SECONDARY)',
               existing_nullable=True)
    op.alter_column('mdm_rel_project_product', 'product_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='产品ID',
               existing_nullable=False)
    op.alter_column('mdm_rel_project_product', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='所属组织ID',
               existing_nullable=False)
    op.alter_column('mdm_rel_project_product', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='项目ID',
               existing_nullable=False)
    op.alter_column('mdm_rel_project_product', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_purchase_contracts', 'capex_opex_flag',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='CAPEX/OPEX标志',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'cost_code_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='成本科目ID',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'end_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='合同结束日期',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'start_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='合同开始日期',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='币种',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'total_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='合同总额',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'vendor_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='供应商ID',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'vendor_name',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='供应商名称',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'title',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='合同标题',
               existing_nullable=True)
    op.alter_column('mdm_purchase_contracts', 'contract_no',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='合同编号',
               existing_nullable=False)
    op.alter_column('mdm_purchase_contracts', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_constraint(None, 'mdm_projects', type_='foreignkey')
    op.alter_column('mdm_projects', 'description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='项目描述',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'lead_repo_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主代码仓库ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'budget_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='预算类型 (CAPEX/OPEX)',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'budget_code',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='预算编码',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'system_code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='数据来源系统',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'external_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='外部系统项目ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'actual_end_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='实际结束时间',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'actual_start_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='实际开始时间',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'plan_end_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='计划结束日期',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'plan_start_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='计划开始日期',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='负责部门ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'pm_user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='项目经理ID',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='项目状态 (PLAN/ACTIVE/SUSPENDED/CLOSED)',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'project_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='项目类型 (研发项目/运维项目/POC)',
               existing_nullable=True)
    op.alter_column('mdm_projects', 'project_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='项目名称',
               existing_nullable=False)
    op.alter_column('mdm_projects', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='项目唯一标识',
               existing_nullable=False)
    op.drop_column('mdm_projects', 'location_id')
    op.drop_index(op.f('ix_mdm_product_is_current'), table_name='mdm_product')
    op.alter_column('mdm_product', 'product_manager_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='产品经理ID',
               existing_nullable=True)
    op.alter_column('mdm_product', 'owner_team_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='负责团队ID',
               existing_nullable=True)
    op.alter_column('mdm_product', 'artifact_path',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='制品存储路径',
               existing_nullable=True)
    op.alter_column('mdm_product', 'repo_url',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='主代码仓库URL',
               existing_nullable=True)
    op.alter_column('mdm_product', 'lifecycle_status',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='生命周期状态 (Active/Deprecated/EOL)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'checksum',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='最新版本校验码',
               existing_nullable=True)
    op.alter_column('mdm_product', 'runtime_env',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='运行环境配置 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'specification',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='产品规格配置 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'version_schema',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='版本命名规则 (SemVer/CalVer)',
               existing_nullable=False)
    op.alter_column('mdm_product', 'category',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='产品分类 (平台/应用/组件)',
               existing_nullable=True)
    op.alter_column('mdm_product', 'product_description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='产品描述',
               existing_nullable=False)
    op.alter_column('mdm_product', 'product_name',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='产品名称',
               existing_nullable=False)
    op.alter_column('mdm_product', 'product_code',
               existing_type=sa.VARCHAR(length=25),
               comment=None,
               existing_comment='产品编码',
               existing_nullable=False)
    op.alter_column('mdm_product', 'product_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='产品唯一标识',
               existing_nullable=False)
    op.drop_column('mdm_product', 'is_deleted')
    op.drop_column('mdm_product', 'is_current')
    op.drop_column('mdm_product', 'effective_to')
    op.drop_column('mdm_product', 'effective_from')
    op.drop_column('mdm_product', 'sync_version')
    op.alter_column('mdm_organizations', 'cost_center',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='成本中心编码',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'manager_user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='部门负责人用户ID',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'parent_org_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='上级组织ID',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'org_level',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='组织层级 (1=公司, 2=部门, 3=团队)',
               existing_nullable=True)
    op.alter_column('mdm_organizations', 'org_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='组织名称',
               existing_nullable=False)
    op.alter_column('mdm_organizations', 'org_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='组织唯一标识 (HR系统同步)',
               existing_nullable=False)
    op.alter_column('mdm_organizations', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_organizations_id_seq'::regclass)"))
    op.drop_constraint(None, 'mdm_metric_definitions', type_='foreignkey')
    op.alter_column('mdm_metric_definitions', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否启用 (逻辑删除标志)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'status',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='生命周期状态 (DRAFT:草稿 / RELEASED:已发布 / DEPRECATED:已废弃)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'update_cycle',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='数据刷新周期 (Realtime, T+1, Hourly)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'time_grain',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='统计时间粒度 (Daily, Weekly, Monthly)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'business_owner_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='指标业务负责人ID (PDM/Data Owner)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'is_standard',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否集团标准指标 (True: 锁定口径, 不允许随意修改)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'dimension_scope',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='允许下钻的维度列表 (JSON List, 如 ["dept", "application", "priority"])',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'source_model',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='来源数据模型 (关联 dbt 模型或数据库表名)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'aggregate_type',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='聚合方式 (SUM, AVG, COUNT, MAX, MIN)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'unit',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='度量单位 (%, ms, Hours, Count, CNY)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'calculation_logic',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='计算逻辑说明 (SQL公式或自然语言描述)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'metric_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='指标类型 (ATOMIC:原子指标 / DERIVED:派生指标 / COMPOSITE:复合指标)',
               existing_nullable=True)
    op.alter_column('mdm_metric_definitions', 'domain',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='所属业务域 (DEVOPS/FINANCE/OPERATION)',
               existing_nullable=False)
    op.alter_column('mdm_metric_definitions', 'metric_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='指标展示名称 (如 生产环境平均修复时间)',
               existing_nullable=False)
    op.alter_column('mdm_metric_definitions', 'metric_code',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='指标唯一编码 (如 DORA_MTTR_PROD)',
               existing_nullable=False)
    op.drop_index(op.f('ix_mdm_locations_code'), table_name='mdm_locations')
    op.alter_column('mdm_locations', 'manager_user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='负责人ID',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'region',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='区域 (华北/华东/华南)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'parent_id',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='上级位置ID',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'location_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='位置类型 (country/province/city/site/datacenter)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'short_name',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='简称 (如 广东)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'location_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='位置名称 (如 广东省)',
               existing_nullable=False)
    op.alter_column('mdm_locations', 'location_id',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='位置唯一标识 (如 UUID)',
               existing_nullable=True)
    op.alter_column('mdm_locations', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('mdm_locations', 'code')
    op.alter_column('mdm_labor_rate_config', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_labor_rate_config', 'effective_date',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='生效日期',
               existing_nullable=True)
    op.alter_column('mdm_labor_rate_config', 'currency',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='币种',
               existing_nullable=True)
    op.alter_column('mdm_labor_rate_config', 'hourly_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='时费率 (元)',
               existing_nullable=True)
    op.alter_column('mdm_labor_rate_config', 'daily_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='日费率 (元)',
               existing_nullable=False)
    op.alter_column('mdm_labor_rate_config', 'job_title_level',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='职级 (P5/P6/P7/M1/M2)',
               existing_nullable=False)
    op.alter_column('mdm_labor_rate_config', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_constraint(None, 'mdm_incidents', type_='foreignkey')
    op.drop_constraint(None, 'mdm_incidents', type_='foreignkey')
    op.drop_constraint(None, 'mdm_incidents', type_='foreignkey')
    op.drop_constraint(None, 'mdm_incidents', type_='foreignkey')
    op.alter_column('mdm_incidents', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('mdm_incidents', 'updated_at')
    op.drop_column('mdm_incidents', 'created_at')
    op.drop_column('mdm_incidents', 'service_id')
    op.drop_column('mdm_incidents', 'project_id')
    op.drop_column('mdm_incidents', 'owner_id')
    op.drop_column('mdm_incidents', 'financial_loss')
    op.drop_column('mdm_incidents', 'affected_users')
    op.drop_column('mdm_incidents', 'post_mortem_url')
    op.drop_column('mdm_incidents', 'root_cause_category')
    op.drop_column('mdm_incidents', 'location_id')
    op.drop_column('mdm_incidents', 'resolved_at')
    op.drop_column('mdm_incidents', 'detected_at')
    op.drop_column('mdm_incidents', 'occurred_at')
    op.drop_column('mdm_incidents', 'status')
    op.drop_column('mdm_incidents', 'severity')
    op.drop_column('mdm_incidents', 'description')
    op.drop_column('mdm_incidents', 'title')
    op.alter_column('mdm_identity_mappings', 'last_active_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='最后活跃时间',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'confidence_score',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='匹配置信度 (0.0-1.0)',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'mapping_status',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='映射状态 (VERIFIED/PENDING/REJECTED)',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'external_email',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='外部系统邮箱',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'external_username',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='外部系统用户名',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'external_user_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='外部系统用户ID',
               existing_nullable=False)
    op.alter_column('mdm_identity_mappings', 'source_system',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='来源系统 (gitlab/jira/sonar)',
               existing_nullable=False)
    op.alter_column('mdm_identity_mappings', 'global_user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='全局用户ID',
               existing_nullable=True)
    op.alter_column('mdm_identity_mappings', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('mdm_identities', 'eloc_rank',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='ELOC排名',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'total_eloc',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='累计有效代码行数',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'is_survivor',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否通过合并保留的账号',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否在职',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'department_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='所属部门ID',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'primary_email',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='主邮箱地址',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'full_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='用户姓名',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'username',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='登录用户名',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'employee_id',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='HR系统工号',
               existing_nullable=True)
    op.alter_column('mdm_identities', 'global_user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='全局唯一用户标识',
               existing_nullable=False)
    op.drop_constraint(None, 'mdm_epic', type_='foreignkey')
    op.drop_constraint(None, 'mdm_epic', type_='foreignkey')
    op.drop_constraint(None, 'mdm_epic', type_='foreignkey')
    op.drop_constraint(None, 'mdm_epic', type_='foreignkey')
    op.drop_index(op.f('ix_mdm_epic_epic_code'), table_name='mdm_epic')
    op.alter_column('mdm_epic', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('mdm_epic', 'updated_at')
    op.drop_column('mdm_epic', 'created_at')
    op.drop_column('mdm_epic', 'tags')
    op.drop_column('mdm_epic', 'involved_teams')
    op.drop_column('mdm_epic', 'external_id')
    op.drop_column('mdm_epic', 'web_url')
    op.drop_column('mdm_epic', 'is_confidential')
    op.drop_column('mdm_epic', 'color')
    op.drop_column('mdm_epic', 'progress')
    op.drop_column('mdm_epic', 'actual_end_date')
    op.drop_column('mdm_epic', 'actual_start_date')
    op.drop_column('mdm_epic', 'planned_end_date')
    op.drop_column('mdm_epic', 'planned_start_date')
    op.drop_column('mdm_epic', 'due_date_is_fixed')
    op.drop_column('mdm_epic', 'start_date_is_fixed')
    op.drop_column('mdm_epic', 'group_id')
    op.drop_column('mdm_epic', 'owner_id')
    op.drop_column('mdm_epic', 'budget_cap')
    op.drop_column('mdm_epic', 'investment_theme')
    op.drop_column('mdm_epic', 'okr_objective_id')
    op.drop_column('mdm_epic', 'priority')
    op.drop_column('mdm_epic', 'status')
    op.drop_column('mdm_epic', 'description')
    op.drop_column('mdm_epic', 'title')
    op.drop_column('mdm_epic', 'epic_code')
    op.drop_column('mdm_epic', 'parent_id')
    op.drop_index(op.f('ix_mdm_entity_topology_is_current'), table_name='mdm_entity_topology')
    op.alter_column('mdm_entity_topology', 'sync_version',
               existing_type=sa.INTEGER(),
               nullable=True)
    op.alter_column('mdm_entity_topology', 'meta_info',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='额外元数据连接信息 (JSON, 如 webhook_id, bind_key)',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'last_verified_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='最后一次验证连接有效的时间',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='关联是否有效',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'element_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='资源类型 (source-code/ci-pipeline/k8s-deployment/db-instance)',
               existing_nullable=True)
    op.alter_column('mdm_entity_topology', 'external_resource_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='外部资源唯一标识 (如 Project ID, Repo URL)',
               existing_nullable=False)
    op.alter_column('mdm_entity_topology', 'system_code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='来源系统代码 (如 gitlab-corp)',
               existing_nullable=False)
    op.alter_column('mdm_entity_topology', 'service_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='所属业务服务ID',
               existing_nullable=False)
    op.alter_column('mdm_entity_topology', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('mdm_entity_topology', 'is_deleted')
    op.drop_column('mdm_entity_topology', 'effective_to')
    op.drop_column('mdm_entity_topology', 'effective_from')
    op.drop_column('mdm_entity_topology', 'env_tag')
    op.drop_column('mdm_entity_topology', 'resource_name')
    op.alter_column('mdm_cost_codes', 'is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否启用',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'default_capex_opex',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='默认CAPEX/OPEX属性',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'parent_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='上级科目ID',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='科目描述',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'category',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='科目分类 (人力/硬件/软件/服务)',
               existing_nullable=True)
    op.alter_column('mdm_cost_codes', 'name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='科目名称',
               existing_nullable=False)
    op.alter_column('mdm_cost_codes', 'code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='科目编码',
               existing_nullable=False)
    op.alter_column('mdm_cost_codes', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('mdm_cost_codes_id_seq'::regclass)"))
    op.alter_column('mdm_contract_payment_nodes', 'achieved_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='达成时间',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'is_achieved',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否已达成',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'linked_milestone_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联里程碑ID',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'linked_system',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='关联系统 (gitlab/jira/manual)',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'billing_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='收款金额',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'billing_percentage',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='收款比例 (%)',
               existing_nullable=True)
    op.alter_column('mdm_contract_payment_nodes', 'node_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='节点名称',
               existing_nullable=False)
    op.alter_column('mdm_contract_payment_nodes', 'contract_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联合同ID',
               existing_nullable=False)
    op.alter_column('mdm_contract_payment_nodes', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_index(op.f('ix_mdm_compliance_issues_entity_id'), table_name='mdm_compliance_issues')
    op.alter_column('mdm_compliance_issues', 'metadata_payload',
               existing_type=postgresql.JSON(astext_type=sa.Text()),
               comment=None,
               existing_comment='额外元数据 (JSON)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='问题详情',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'status',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='状态 (OPEN/IN_REVIEW/RESOLVED/ACCEPTED)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'entity_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='关联实体ID (项目/服务)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'severity',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='严重等级 (Critical/High/Medium/Low)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'issue_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='问题类型 (安全漏洞/许可证违规/合规缺失)',
               existing_nullable=True)
    op.alter_column('mdm_compliance_issues', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('mdm_compliance_issues', 'updated_at')
    op.drop_column('mdm_compliance_issues', 'created_at')
    op.drop_constraint(None, 'mdm_company', type_='foreignkey')
    op.drop_index(op.f('ix_mdm_company_tax_id'), table_name='mdm_company')
    op.alter_column('mdm_company', 'company_id',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='公司唯一标识 (如 COM-BJ-01)',
               existing_nullable=False)
    op.drop_column('mdm_company', 'updated_at')
    op.drop_column('mdm_company', 'created_at')
    op.drop_column('mdm_company', 'is_active')
    op.drop_column('mdm_company', 'location_id')
    op.drop_column('mdm_company', 'registered_address')
    op.drop_column('mdm_company', 'fiscal_year_start')
    op.drop_column('mdm_company', 'currency')
    op.drop_column('mdm_company', 'tax_id')
    op.drop_column('mdm_company', 'short_name')
    op.drop_column('mdm_company', 'name')
    op.alter_column('mdm_calendar', 'season_tag',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='季节标签 (春/夏/秋/冬)',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'week_of_year',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='年内周数',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'fiscal_quarter',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='财务季度',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'fiscal_year',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='财年',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'holiday_name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='节假日名称',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'is_holiday',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否节假日',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'is_workday',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否工作日',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'day_of_week',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='星期几 (1=周一, 7=周日)',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'quarter_number',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='季度 (1-4)',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'month_number',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='月份 (1-12)',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'year_number',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='年份',
               existing_nullable=True)
    op.alter_column('mdm_calendar', 'date_day',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='日期',
               existing_nullable=False)
    op.alter_column('mdm_calendar', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_constraint(None, 'mdm_business_systems', type_='foreignkey')
    op.drop_index(op.f('ix_mdm_business_systems_domain'), table_name='mdm_business_systems')
    op.alter_column('mdm_business_systems', 'owner_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='技术负责人 (Architect)',
               existing_nullable=True)
    op.alter_column('mdm_business_systems', 'domain',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='所属业务域 (如 电商/供应链/财务)',
               existing_nullable=True)
    op.alter_column('mdm_business_systems', 'description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='系统业务描述与边界定义',
               existing_nullable=True)
    op.alter_column('mdm_business_systems', 'name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='系统中文名称',
               existing_nullable=False)
    op.alter_column('mdm_business_systems', 'code',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='系统标准代号 (如 trade-center)',
               existing_nullable=False)
    op.alter_column('mdm_business_systems', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.drop_column('mdm_business_systems', 'business_owner_id')
    op.drop_column('mdm_business_systems', 'dr_level')
    op.drop_column('mdm_business_systems', 'primary_tech_stack')
    op.drop_column('mdm_business_systems', 'architecture_type')
    op.drop_column('mdm_business_systems', 'rank')
    op.drop_column('mdm_business_systems', 'status')
    op.alter_column('daily_dev_stats', 'total_churn',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='当日总代码翻动行数',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'total_impact',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='当日总影响力得分',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'commit_count',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='当日提交次数',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'last_commit_time',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='当日最后提交时间',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'first_commit_time',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='当日首次提交时间',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='统计日期',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'user_id',
               existing_type=sa.UUID(),
               comment=None,
               existing_comment='用户ID',
               existing_nullable=True)
    op.alter_column('daily_dev_stats', 'id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='自增主键',
               existing_nullable=False,
               autoincrement=True)
    op.alter_column('commit_metrics', 'refactor_ratio',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='重构代码占比',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'is_legacy_refactor',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否为遗留代码重构',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'is_merge',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否为合并提交',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'file_count',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='涉及文件数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'test_lines',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='测试代码行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'comment_lines',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='注释行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'churn_lines',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='代码翻动行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'impact_score',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='代码影响力得分',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'eloc_score',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='有效代码行数得分',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'raw_deletions',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='原始删除行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'raw_additions',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='原始新增行数',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'committed_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='提交时间',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'author_email',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='提交者邮箱',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'project_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='所属业务项目ID',
               existing_nullable=True)
    op.alter_column('commit_metrics', 'commit_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='提交SHA哈希值',
               existing_nullable=False)
    op.create_table('fct_performance_records',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False),
    sa.PrimaryKeyConstraint('id', name='fct_performance_records_pkey')
    )
    op.create_table('fct_user_activity_profiles',
    sa.Column('id', sa.BIGINT(), autoincrement=True, nullable=False),
    sa.PrimaryKeyConstraint('id', name='fct_user_activity_profiles_pkey')
    )
    op.create_table('fct_test_execution_summary',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False),
    sa.PrimaryKeyConstraint('id', name='fct_test_execution_summary_pkey')
    )
    op.create_table('mdm_entities_topology',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False),
    sa.Column('entity_id', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('target_id', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('internal_id', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('is_current', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('sync_version', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='mdm_entities_topology_pkey')
    )
    op.create_index('ix_mdm_entities_topology_entity_id', 'mdm_entities_topology', ['entity_id'], unique=False)
    # ### end Alembic commands ###
