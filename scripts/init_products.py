"""初始化产品主数据 (MDM_PRODUCT)。

本脚本根据用户提供的产品目录图，自动完成以下任务：
1. 录入全量产品信息（代号、名称、产品线）。
2. 建立产品与所属部门（中心）的关联。

执行方式:
    python scripts/init_products.py
"""
import sys
import os
import logging
from sqlalchemy import create_engine
from sqlalchemy.orm import Session
from pathlib import Path

# 添加项目根目录到路径
sys.path.insert(0, str(Path(__file__).parent.parent))
from devops_collector.config import settings
from devops_collector.models import Base, Product, Organization

# 日志配置
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# 产品原始数据 (产品代号, 产品名称, 产品线, 归属中心名称)
PRODUCT_RAW_DATA = [
    # 财政研发中心
    ('BIM-JS', '基础信息管理-江苏', '预算一体化-江苏', '财政研发中心'),
    ('BDGJS', '指标调整调剂-江苏', '预算一体化-江苏', '财政研发中心'),
    ('PDM-JS', '项目库管理-江苏', '预算一体化-江苏', '财政研发中心'),
    ('BDM-JS', '预算编制-江苏', '预算一体化-江苏', '财政研发中心'),
    ('COMMON-JS', '框架管理-江苏', '预算一体化-江苏', '财政研发中心'),
    ('PORTAL-JS', '门户管理-江苏', '预算一体化-江苏', '财政研发中心'),
    ('GZXWGLXT-JS', '国债项目管理系统-江苏', '预算一体化-江苏', '财政研发中心'),
    ('GBDM-JS', '政府预算-江苏', '预算一体化-江苏', '财政研发中心'),
    ('FASP', '中台服务', '预算一体化-通用', '财政研发中心'),
    ('COMMON', '框架管理', '预算一体化-通用', '财政研发中心'),
    ('ESMS', '预算执行监督系统', '预算一体化-通用', '财政研发中心'),
    ('BIM', '基础信息管理', '预算一体化-通用', '财政研发中心'),
    ('PORTAL', '门户管理', '预算一体化-通用', '财政研发中心'),
    ('PDM', '项目库管理', '预算一体化-通用', '财政研发中心'),
    ('BDG', '预算调整和调剂', '预算一体化-通用', '财政研发中心'),
    ('BDM', '预算编制', '预算一体化-通用', '财政研发中心'),
    ('PAY', '国库集中支付', '预算一体化-通用', '财政研发中心'),
    ('GBDM', '政府预算', '预算一体化-通用', '财政研发中心'),
    ('DATACOMMON', '采集组件', '预算一体化-通用', '财政研发中心'),
    ('SALARY', '工资系统', '预算一体化-通用', '财政研发中心'),
    ('REALPAY', '实拨管理', '预算一体化-通用', '财政研发中心'),
    ('DITS', '财政运行监测', '预算一体化-通用', '财政研发中心'),
    ('INSPECT', '动态监控', '预算一体化-通用', '财政研发中心'),
    ('BAMS', '银行账户', '预算一体化-通用', '财政研发中心'),
    ('ACCT', '总会计核算', '预算一体化-通用', '财政研发中心'),
    ('GL', '预算指标账', '预算一体化-通用', '财政研发中心'),
    ('gabm', '国资预算', '预算一体化-通用', '财政研发中心'),
    ('SPEACCT', '专户管理', '预算一体化-通用', '财政研发中心'),
    ('RQREPORT', '打印和会计报表', '预算一体化-通用', '财政研发中心'),
    ('ndpm', '国债项目系统', '预算一体化-通用', '财政研发中心'),
    ('MONITOR', '中台监控', '预算一体化-通用', '财政研发中心'),
    ('DFMS', '直达资金管理', '预算一体化-通用', '财政研发中心'),
    ('CARD', '公务卡系统', '预算一体化-通用', '财政研发中心'),
    ('EXCASH', '国库现金管理系统', '预算一体化-通用', '财政研发中心'),
    ('IFMISAI', '预算管理一体化AI应用', '预算一体化-通用', '财政研发中心'),
    ('RDMS', '资料收发管理系统', '预算一体化-通用', '财政研发中心'),
    ('PLM', '政策库管理', '预算一体化-通用', '财政研发中心'),
    ('HPRS', '项目追踪系统', '预算一体化-通用', '财政研发中心'),
    ('PAY-ZJ', '国库集中支付-浙江', '预算一体化-浙江', '财政研发中心'),
    ('CARD-ZJ', '公务卡系统-浙江', '预算一体化-浙江', '财政研发中心'),
    ('BDG-ZJ', '预算调整和调剂-浙江', '预算一体化-浙江', '财政研发中心'),
    # 创新业务拓展中心
    ('OBS', '预决算公开与分析查询', '创新业务', '创新业务拓展中心'),
    ('SI', '社会保险基金预算管理系统', '创新业务', '创新业务拓展中心'),
    # 大数据及AI业务拓展中心
    ('BDBS', '通用业务管理平台', '大数据', '大数据及AI业务拓展中心'),
    ('BDP', '大数据平台', '大数据', '大数据及AI业务拓展中心'),
    ('HQREPORT', '大数据通用报表系统', '大数据', '大数据及AI业务拓展中心'),
    # 互联网与协同业务拓展中心
    ('FS-SRS_JGL', '非税收入收缴管理系统', '非税', '互联网与协同业务拓展中心'),
    ('CYJF', '财云缴费', '非税', '互联网与协同业务拓展中心'),
    ('FS-CZOA', '财政管理信息系统', '非税', '互联网与协同业务拓展中心'),
    ('FS-CZPJGLPT', '财政票据管理平台', '非税', '互联网与协同业务拓展中心'),
    ('TC', '易创快速开发平台', '协同', '互联网与协同业务拓展中心'),
    # 行业业务拓展中心
    ('HY-BUSI', '微服务-业务产品', '行业业务', '行业业务拓展中心'),
    ('TRAFFIC', '普通省道和农村公路“以奖代补”考核数据支撑系统', '行业业务', '行业业务拓展中心'),
    ('LMYS', '链民农社', '行业业务', '行业业务拓展中心'),
    ('HY-QK-CHART', '微服务-乾坤图表服务产品', '行业业务', '行业业务拓展中心'),
    ('HY-QK-CK', '微服务-乾坤仓库产品', '行业业务', '行业业务拓展中心'),
    ('HY-ZSK', '微服务-知识库产品', '行业业务', '行业业务拓展中心'),
    ('HY-QK-TABLE', '微服务-乾坤表表服务产品', '行业业务', '行业业务拓展中心'),
    ('HY-ACCESS', '微服务-数据接入产品', '行业业务', '行业业务拓展中心'),
    ('TECH', '科技监管系统', '行业业务', '行业业务拓展中心'),
    ('HY-XQC', '业务范围中心-需求仓库', '行业业务', '行业业务拓展中心'),
    ('HY-VJFW', '微服务-文件服务产品', '行业业务', '行业业务拓展中心'),
    ('HY-JSTX', '微服务-即时通讯产品', '行业业务', '行业业务拓展中心'),
    ('HY-INS', '微服务-监控产品', '行业业务', '行业业务拓展中心'),
    # 政务研发中心
    ('BPDM', '项目枢纽平台', '项目枢纽', '政务研发中心'),
    ('GFA-DEM-HN', '部门决算-海南', '预算一体化-海南', '政务研发中心'),
    ('GFA-GOM-HN', '财政总决算-海南', '预算一体化-海南', '政务研发中心'),
    ('INEXREPORT-HN', '旬月报系统-海南', '预算一体化-海南', '政务研发中心'),
    ('PERFORMANCE', '绩效-海南', '预算一体化-海南', '政务研发中心'),
    ('REPORT-HN', '综合查询-海南', '预算一体化-海南', '政务研发中心'),
    ('PDM-HN', '项目库-海南', '预算一体化-海南', '政务研发中心'),
    ('BIM-HN', '基础信息-海南', '预算一体化-海南', '政务研发中心'),
    ('BDM-HN', '预算编制-海南', '预算一体化-海南', '政务研发中心'),
    ('EDUP', '部属高校预算绩效', '政务', '政务研发中心'),
    ('DFCZFXPJ', '地方财政分析评价系统', '政务', '政务研发中心'),
    ('SALARY-JZXT', '军队转业干部信息管理系统', '政务', '政务研发中心'),
    ('YSJL-CZB', '预算管理交流平台', '政务', '政务研发中心'),
    ('CLLBDG', '财务项目管理（三级项目管理）', '政务', '政务研发中心'),
    ('BUSCOMMON-ZW', '政务框架', '政务', '政务研发中心'),
    ('CASH-CZB', '财政部现金管理系统', '政务', '政务研发中心'),
    ('INSPECT-CZB', '财政国库动态监控', '政务', '政务研发中心'),
    # 智慧云政务研发中心
    ('PMKPI', '预算财政绩效', '财政绩效', '智慧云政务研发中心'),
    ('GLA', '单位会计核算', '单位核算', '智慧云政务研发中心'),
    ('GLA-XJ', '单位会计核算-新疆', '单位核算', '智慧云政务研发中心'),
    ('G-GLA', '单位核算（G核）', '轻松报', '智慧云政务研发中心'),
    ('ORS', '网上报销2.0', '轻松报', '智慧云政务研发中心'),
    ('INVOICE', '华青智慧', '轻松报', '智慧云政务研发中心'),
    ('BGTPM', '项目管理', '轻松报', '智慧云政务研发中心'),
    ('CPAS', '合同管理', '轻松报', '智慧云政务研发中心'),
    ('OFFCAR', '公务用车', '轻松报', '智慧云政务研发中心'),
    ('ORSAPP', '网上报销小程序', '轻松报', '智慧云政务研发中心'),
    ('ASSET', '资产管理', '轻松报', '智慧云政务研发中心'),
    ('GPA', '采购管理', '轻松报', '智慧云政务研发中心'),
    ('BPPF-PJBT', '部门项目预算绩效管理系统', '涉企分析', '智慧云政务研发中心'),
    ('GFR-HN', '财务报告-海南', '预算一体化-海南', '智慧云政务研发中心'),
]

def init_products():
    """解析数据并初始化产品主数据。"""
    engine = create_engine(settings.database.uri)
    Base.metadata.create_all(engine)
    
    with Session(engine) as session:
        logger.info('开始初始化全量产品目录...')
        
        for p_id, p_name, p_line, owner_name in PRODUCT_RAW_DATA:
            # 匹配所属部门 ID (CTR-中心名 模式)
            owner_id = f"CTR-{owner_name}"
            
            # 验证部门是否存在
            org = session.query(Organization).filter_by(org_id=owner_id).first()
            if not org:
                logger.warning(f"产品 {p_name} 的归属部门 {owner_name} ({owner_id}) 在组织架构中不存在，跳过部门关联。")
                owner_id = None
            
            existing = session.query(Product).filter_by(product_id=p_id).first()
            if not existing:
                product = Product(
                    product_id=p_id,
                    product_code=p_id,
                    product_name=p_name,
                    product_description=f"{p_line} 业务线下的 {p_name} 产品",
                    category=p_line,
                    version_schema='SemVer',
                    lifecycle_status='Active',
                    owner_team_id=owner_id
                )
                session.add(product)
                logger.info(f"已创建产品: {p_name} ({p_id})")
            else:
                existing.product_name = p_name
                existing.category = p_line
                existing.owner_team_id = owner_id
                logger.info(f"已更新产品: {p_name}")
        
        session.commit()
        logger.info('✅ 产品目录初始化完成！')

if __name__ == '__main__':
    init_products()
