# GitLab 测试管理模块：需求评审流与权限规范指引 (V2.2)

本指南旨在向 DevOps 团队及 QA 工程师说明如何在基于 GitLab 社区版二开的“测试管理中台”中进行规范的需求录入、评审以及端到端追溯。

---

## 1. 需求录入规范 (Requirement Entry)

在该二开方案中，需求以 GitLab Issue 为载体，通过标签体系进行识别。

*   **识别标签**：`type::requirement` (必须)。
*   **初始状态**：新创建的需求默认打上 `review-state::draft` 标签。
*   **录入途径**：
    1.  **TestHub 中台**：点击 `Requirements` 视图中的 `+ Req` 按钮。
    2.  **GitLab 原生界面**：创建 Issue 并手动添加 `type::requirement` 标签。

---

## 2. 需求评审流 (Review Workflow)

需求必须经过正式评审并进入“已审核”状态，才能被包含在“追溯矩阵”和“质量报告”中。整个生命周期包含四个阶段：

| 状态 | 标签 | 说明 | 允许的操作 |
| :--- | :--- | :--- | :--- |
| **草稿 (Draft)** | `review-state::draft` | 需求编辑中，不可用于生产追溯。 | 提交评审 |
| **评审中 (Under Review)** | `review-state::under-review` | 业务/技术负责人正在进行合规性和可行性评审。 | 通过 (Approve) / 拒绝 (Reject) |
| **已审核 (Approved)** | `review-state::approved` | **核心状态**。需求正式生效，可关联测试用例。 | 撤回/重置 |
| **已拒绝 (Rejected)** | `review-state::rejected` | 需求不合理或被暂时搁置。 | 返回草稿 |

---

## 3. 权限控制规范 (Permission Control)

评审权限与 GitLab 的项目成员角色深度绑定，确保流程的严谨性：

| 操作 | 所需最低权限级别 (GitLab Access Level) | 角色参考 |
| :--- | :--- | :--- |
| **创建需求 / 提交评审** | `20 (Reporter)` 或以上 | 开发人员、测试人员 |
| **审核通过 (Approve)** | **`40 (Maintainer)`** 或以上 | 项目主管、质量负责人 |
| **拒绝驳回 (Reject)** | **`40 (Maintainer)`** 或以上 | 项目主管、质量负责人 |

*   **校验机制**：后端接口会在执行 Approve/Reject 时实时查询操作者在 GitLab 该项目中的权限等级。若级别低于 40，系统将阻断操作并返回 `403 Forbidden`。

---

## 4. 端到端追溯闭环 (E2E Traceability)

### 4.1 关联逻辑
测试人员在创建测试用例（Test Case）时，必须引用已通过评审的需求 IID。
*   **中台关联**：创建用例时填写 `Requirement IID` 字段。
*   **手动关联**：在测试用例 Issue 描述中添加：`关联需求]: # {IID}`。

### 4.2 追溯矩阵面板
*   **展示策略**：看板仅展示 `review-state::approved` 的需求。
*   **质量反馈**：矩阵会实时拉取关联测试用例的最新执行状态（Pass/Fail/Blocked/Pending）。

---

## 5. 审计轨迹 (Audit Trail)

所有通过中台执行的状态变更都会在 GitLab Issue 下方自动生成审计评论：
*   **记录内容**：操作者 ID、权限等级、目标状态、执行时间、结果摘要。
*   **示例**：
    > 💠 **需求评审状态变更**
    > - **目标状态**: APPROVED
    > - **评审人 ID**: 12 (Level: Maintainer+)
    > - **结果**: ✅ 已准入

---

**修订记录**：
- V2.1: 引入需求标签识别逻辑。
- V2.2: 增加四段式评审流及 Maintainer 级权限校验。
