# 用户接入与指标指南 (User & Metrics Guide)

**面向对象**: 研发工程师、Tech Lead、产品经理、PMO
**版本**: 3.3.0
**日期**: 2025-12-16

---

## 1. 接入指南 (Onboarding Guide)

### 1.1 什么是 DevOps Data Collector?
这是一个自动化的效能数据采集平台，不需要您手动填报数据。只要您的项目在公司的 GitLab 上，且配置了 SonarQube，数据就会自动进入系统。

### 1.2 如何接入 GitLab 数据?
*   **自动发现**: 系统每天凌晨会自动扫描 GitLab 全量项目。
*   **归属确认**: 请确保您的 GitLab 项目位于正确的 **Group** 下。系统会根据 Group Description 自动将项目归属到对应的部门。

### 1.3 如何接入 SonarQube 数据?
为了让系统能自动关联 GitLab 代码库和 SonarQube 质量报告，请遵循以下命名规范：
*   **Sonar Project Key**: 必须与 GitLab 的 `Path with namespace` 一致（推荐将 `/` 替换为 `:`）。
    *   *GitLab*: `infra/devops-platform`
    *   *Sonar*: `infra:devops-platform`
*   如果无法遵循此规范，请联系管理员手动在数据库配置映射。

### 1.4 如何记录“财务合同”与项目关联?
*   **收入合同**: PMO 将合同号录入系统，并将其收款节点绑定到 GitLab 的 **Milestone**。当 Milestone 状态变为 `Closed` 时，系统自动标记回款达成。
*   **采购合同**: 管理员将云服务或外包合同录入，系统按自然月自动在 `resource_costs` 中分摊流水。

---

---

## 2. 进阶功能：数据回放 (Data Replay)

如果您发现某些历史数据的计算逻辑有误（例如 Lead Time 算错了），或者系统升级了新的提取逻辑，无需重新同步海量数据。

### 2.1 什么是数据回放？
系统会将采集到的每一次 API 原始响应保存下来。数据回放就是让系统“假装”重新接收了一次这些历史数据，并用最新的代码逻辑重新处理一遍。

### 2.2 如何触发？
请联系管理员运行补偿脚本：
```bash
# 重算 GitLab 的 Merge Request 数据
python scripts/reprocess_staging_data.py
```

---

## 3. 指标词典与解读 (Metrics Dictionary)

### 2.1 交付效能 (Delivery - DORA)
*关注“快不快”和“稳不稳”*

#### 🚀 部署频率 (Deployment Frequency)
*   **定义**: 单位时间内成功部署到生产环境的次数。
*   **解读**: 越高越好。高频部署意味着更小的发布粒度 (`Small Batch Size`)，能降低风险。

#### ⏱️ 变更前置时间 (Lead Time for Changes)
*   **定义**: 从代码提交 (Commit) 到代码成功运行在生产环境 (Deployment) 的时间。
*   **解读**: 越短越好。如果时间过长，请检查 CR 是否积压、流水线是否缓慢。

### 2.2 代码质量 (Quality - SonarQube)
*关注“好不好”*

#### 🌡️ 技术债务 (Technical Debt / SQALE)
*   **定义**: 修复代码中所有可维护性问题所需的预估时间 (如 "5d" 代表 5天)。
*   **解读**: 持续上升是危险信号，意味着团队在“借高利贷”开发。

#### 🛡️ 代码覆盖率 (Code Coverage)
*   **定义**: 单元测试覆盖的代码行数比例。核心模块建议 >80%。

### 2.3 战略评估 (Strategy - PMO NEW)
*关注“值不值”*

#### 🧩 战略投资矩阵 (Strategic Portfolio Matrix)
我们将项目分为四个象限（X轴=开发速度，Y轴=代码质量）：
*   **🌟 明星 (Stars)**: 高速度 + 高质量。这是团队的核心资产，应**持续投入**。
*   **🐄 现金牛 (Cash Cows)**: 低速度 + 高质量。项目稳定，只需**日常维护**。
*   **🐕 瘦狗 (Dogs)**: 低速度 + 低质量。既跑不快又经常坏，建议**归档或重写**。
*   **🚑 问题儿童 (Problem Children)**: 高速度 + 低质量。团队在拼命开发，但背负了巨大债务。**急需重构**。

#### 💰 投入产出比 (ROI Efficiency)
*   **人均吞吐量 (Throughput per FTE)**: 平均每位全职人力交付的 MR 数量。
*   **单位成本 (Cost per Unit)**: 交付一个需求或特性平均消耗的基础设施与人力费用。

### 2.4 协作与文化 (Collaboration & Experience) (New)
*关注“怎么做到的”*

#### 📈 评审深度 (Review Depth)
*   **评审轮次 (Review Cycles)**: MR 从开启到合并间发生的正式修订与再评审次数。
*   **解读**: 轮次适中最好（1-3轮）。大于5轮可能意味着工程基座腐烂或沟通不畅。

#### ⚖️ 工作负荷与健康 (Workload & Balance)
*   **加班提交占比 (Off-hours Activity Ratio)**: 在深夜或周末发生的提交比例。
*   **解读**: 持续高占比可能引发团队倦怠压力，需及时干预。

### 2.5 流程健康 (Governance & Process)
*关注“规不规”*

#### 🚨 流程违规率 (Direct Push Rate)
*   **定义**: 绕过代码评审 (MR) 直接 Push 到主分支的提交占比。
*   **红线**: 任何人不得高于 0%（特殊 Hotfix 除外）。这会破坏审计追踪。

#### 🤝 内源共创指数 (InnerSource Impact)
*   **定义**: 衡量组织技术流动的综合得分。
*   **计算**: `(跨部门贡献率 * 40%) + (被外部项目引用的组件比例 * 60%)`。
*   **解读**: 我们鼓励“去改别人的代码”而不是“造轮子”。高指数代表您或您的团队在组织内具有强大的技术影响力。

#### 🗳️ 评审民主度 (Review Democracy)
*   **定义**: 一个项目的技术决策是否被少数人垄断。
*   **计算**: 每个 MR 的平均独立评审人数。
*   **解读**: 如果该值长期 < 1.1，说明代码评审流于形式或合并权高度集中，潜伏着知识孤岛风险。

### 2.6 敏捷流动与 AI 洞察 (Flow & AI) 🌟 (New)

#### 🌊 流动效能 (Flow Efficiency)
*   **定义**: `有效工作时间 / 总周期时间`。
*   **解读**: 如果您的流动效能低于 40%，代表任务大部分时间在“排队”或“被阻塞”。请检查团队的 `blocked` 标签使用情况。

#### 🤖 AI 业务价值摘要 (AI Value Summary)
*   **描述**: 系统利用 AI 自动读取您的提交记录，生成一段“人话”摘要。
*   **作用**: 让非技术主管也能看懂您本月到底做了什么核心业务贡献。

---

## 3. 如何提升我的指标？ (Actionable Advice)

### 3.1 想要提升“部署频率”？
*   **拆分需求**: 将大需求拆解为 2-3 天可交付的小 Story。
*   **自动化测试**: 提升单元测试覆盖率，让你敢于频繁发布。

### 3.2 想要减少“技术债务”？
*   **童子军军规**: 每次修改代码时，顺手清理一下旁边的“垃圾”（即重构）。
*   **Sonar 门禁**: 在 CI 流水线中开启 Sonar Quality Gate，阻断不达标代码合并。

### 3.3 想要成为“明星项目”？
*   **清理 Issue**: 及时关闭不再做的 Issue，激活陈旧分支。
*   **文档化**: 提升代码注释率，让新人也能快速上手（提升速度）。

---

## 4. 服务台使用指南 (Service Desk) 🌟 (New)

### 4.1 自动身份识别
*   不再需要手动输入“申请人”和“部门”。
*   系统会根据您的登录 Token 自动识别身份。如果您是外部人员，请确保已通过 `auth/register` 完成注册。

### 4.2 提单极简流程
1.  **访问**: 打开 `service_desk_bug.html` (报缺陷) 或 `service_desk_requirement.html` (提需求)。
2.  **填写**: 仅需填写标题、描述、优先级等业务字段。
3.  **追踪**: 提交后自动跳转至 `service_desk_my_tickets.html` 查看进度。
4.  **通知**: 保持 Dashboard 打开，当工单状态变更时，右上角会弹出实时通知 (SSE)。

---

## 5. 常见问题 (FAQ)

### Q: 为什么我的项目被标记为 "Problem Children"?
A: 这意味着您的项目虽然提交活跃（速度快），但 Bug 多或 Sonar 问题多（质量差）。建议安排专门的“技术债偿还周”。

### Q: "Shadow Satisfaction" (隐性满意度) 是怎么算的?
A: 系统通过分析协作行为的“行为指纹”自动推导得分（满分 100）。
- **SLA 扣分**: Bug 修复每超过 24h 扣 10 分。
- **争议扣分**: 评论数异常多 (>10条) 的任务占比越高，扣分越多。
- **返工扣分**: 任务被 Reopen 的次数。
如果您的项目 SSI < 60，系统会对 PMO 触发满意度预警。

### Q: 什么是“协作熵”？
A: 协作熵代表沟通的复杂度。适度的熵值代表健康的探讨，但如果熵值过高（如平均评论 > 15条），通常代表需求不明确或架构争议极大，导致协作内耗严重。

### Q: 我是外部外包人员，没有公司邮箱怎么办?
A: 请联系管理员，将您的个人邮箱录入到 `users` 表，并标记为虚拟账号，即可归并数据。

### Q: 如何开启企业微信/飞书/钉钉告警?
A: 您只需在 `config.ini` 的 `[notifiers]` 章节配置对应平台的 Webhook 地址即可。告警会自动推送到您所在的群组。

### Q: 个人画像中的“响应性”分值较低怎么办?
A: 响应性分值较低可能源于 Bug 修复时效或评审响应延迟。具体的评分阶梯与预警红线请参考 `METRIC_THRESHOLDS_GUIDE.md`。
