<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Desk | ä¸šåŠ¡æ–¹è‡ªåŠ©æœåŠ¡å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.3);
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --card-dark-hover: #334155;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --passed: #10b981;
            --failed: #ef4444;
            --accent: #8b5cf6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.1) 0, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.1) 0, transparent 50%);
            color: var(--text-main);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-dim);
            font-size: 16px;
        }

        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 15px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-main);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group label .required {
            color: var(--failed);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn-primary {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--primary-glow);
        }

        .btn-secondary {
            width: 100%;
            padding: 14px 24px;
            background: var(--card-dark-hover);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--passed);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .success-message h3 {
            color: var(--passed);
            margin-bottom: 10px;
        }

        .tracking-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 15px 0;
        }

        .ticket-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
        }

        .status-in-progress {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--passed);
        }

        .help-text {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ« Service Desk</h1>
            <p>ä¸šåŠ¡æ–¹è‡ªåŠ©æœåŠ¡å° - æäº¤ç¼ºé™·ä¸éœ€æ±‚</p>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('bug')">ğŸ› æäº¤ç¼ºé™·</button>
            <button class="tab-btn" onclick="switchTab('requirement')">ğŸ“‹ æäº¤éœ€æ±‚</button>
            <button class="tab-btn" onclick="switchTab('track')">ğŸ” æŸ¥è¯¢å·¥å•</button>
        </div>

        <!-- Bug æäº¤è¡¨å• -->
        <div id="bugTab" class="tab-content active">
            <div class="form-card">
                <h2 style="margin-bottom: 25px;">æäº¤ç¼ºé™·</h2>
                <form id="bugForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ‚¨çš„å§“å <span class="required">*</span></label>
                            <input type="text" class="form-control" id="bug_name" required>
                        </div>
                        <div class="form-group">
                            <label>æ‚¨çš„é‚®ç®± <span class="required">*</span></label>
                            <input type="email" class="form-control" id="bug_email" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ç¼ºé™·æ ‡é¢˜ <span class="required">*</span></label>
                        <input type="text" class="form-control" id="bug_title" placeholder="ç®€è¦æè¿°é—®é¢˜" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸¥é‡ç¨‹åº¦ <span class="required">*</span></label>
                            <select class="form-control" id="bug_severity" required>
                                <option value="S0">S0 - é˜»å¡æ€§(ç³»ç»Ÿå´©æºƒ/æ•°æ®ä¸¢å¤±)</option>
                                <option value="S1">S1 - ä¸¥é‡(æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨)</option>
                                <option value="S2" selected>S2 - ä¸€èˆ¬(åŠŸèƒ½éƒ¨åˆ†å¼‚å¸¸)</option>
                                <option value="S3">S3 - è½»å¾®(UIé—®é¢˜/ä¼˜åŒ–å»ºè®®)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¼˜å…ˆçº§ <span class="required">*</span></label>
                            <select class="form-control" id="bug_priority">
                                <option value="P0">P0 - ç´§æ€¥</option>
                                <option value="P1">P1 - é«˜</option>
                                <option value="P2" selected>P2 - ä¸­</option>
                                <option value="P3">P3 - ä½</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>çœä»½/åœ°åŸŸ</label>
                            <input type="text" class="form-control" id="bug_province" value="nationwide"
                                placeholder="å¦‚: å››å·ã€æµ™æ±Ÿ">
                        </div>
                        <div class="form-group">
                            <label>ç¯å¢ƒ <span class="required">*</span></label>
                            <select class="form-control" id="bug_environment" required>
                                <option value="production">ç”Ÿäº§ç¯å¢ƒ</option>
                                <option value="staging">é¢„å‘å¸ƒç¯å¢ƒ</option>
                                <option value="test">æµ‹è¯•ç¯å¢ƒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å¤ç°æ­¥éª¤ <span class="required">*</span></label>
                        <textarea class="form-control" id="bug_steps"
                            placeholder="1. æ‰“å¼€xxxé¡µé¢&#10;2. ç‚¹å‡»xxxæŒ‰é’®&#10;3. è§‚å¯Ÿåˆ°..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>å®é™…ç»“æœ <span class="required">*</span></label>
                        <textarea class="form-control" id="bug_actual" placeholder="æè¿°å®é™…å‘ç”Ÿçš„æƒ…å†µ" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>æœŸæœ›ç»“æœ <span class="required">*</span></label>
                        <textarea class="form-control" id="bug_expected" placeholder="æè¿°åº”è¯¥å‘ç”Ÿçš„æƒ…å†µ" required></textarea>
                    </div>

                    <button type="submit" class="btn-primary">æäº¤ç¼ºé™·</button>
                </form>

                <div id="bugSuccess" class="success-message">
                    <h3>âœ… ç¼ºé™·æäº¤æˆåŠŸ!</h3>
                    <p>æ‚¨çš„è¿½è¸ªç :</p>
                    <div class="tracking-code" id="bugTrackingCode"></div>
                    <p style="color: var(--text-dim);">è¯·ä¿å­˜æ­¤è¿½è¸ªç ï¼Œæ‚¨å¯ä»¥éšæ—¶æŸ¥è¯¢å¤„ç†è¿›åº¦ã€‚æˆ‘ä»¬ä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨å¤„ç†ç»“æœã€‚</p>
                    <a id="bugGitlabLink" href="#" target="_blank" style="color: var(--primary);">æŸ¥çœ‹ GitLab Issue</a>
                </div>
            </div>
        </div>

        <!-- éœ€æ±‚æäº¤è¡¨å• -->
        <div id="requirementTab" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 25px;">æäº¤éœ€æ±‚</h2>
                <form id="reqForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ‚¨çš„å§“å <span class="required">*</span></label>
                            <input type="text" class="form-control" id="req_name" required>
                        </div>
                        <div class="form-group">
                            <label>æ‚¨çš„é‚®ç®± <span class="required">*</span></label>
                            <input type="email" class="form-control" id="req_email" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>éœ€æ±‚æ ‡é¢˜ <span class="required">*</span></label>
                        <input type="text" class="form-control" id="req_title" placeholder="ç®€è¦æè¿°éœ€æ±‚" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>éœ€æ±‚ç±»å‹ <span class="required">*</span></label>
                            <select class="form-control" id="req_type" required>
                                <option value="feature">æ–°åŠŸèƒ½</option>
                                <option value="enhancement">åŠŸèƒ½å¢å¼º</option>
                                <option value="bugfix">é—®é¢˜ä¿®å¤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¼˜å…ˆçº§ <span class="required">*</span></label>
                            <select class="form-control" id="req_priority">
                                <option value="P0">P0 - ç´§æ€¥</option>
                                <option value="P1">P1 - é«˜</option>
                                <option value="P2" selected>P2 - ä¸­</option>
                                <option value="P3">P3 - ä½</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>çœä»½/åœ°åŸŸ</label>
                            <input type="text" class="form-control" id="req_province" value="nationwide"
                                placeholder="å¦‚: å…¨å›½ã€å››å·">
                        </div>
                        <div class="form-group">
                            <label>æœŸæœ›äº¤ä»˜æ—¶é—´</label>
                            <input type="date" class="form-control" id="req_delivery">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>éœ€æ±‚æè¿° <span class="required">*</span></label>
                        <textarea class="form-control" id="req_description" style="min-height: 200px;"
                            placeholder="è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚..." required></textarea>
                        <div class="help-text">è¯·å°½å¯èƒ½è¯¦ç»†åœ°æè¿°éœ€æ±‚èƒŒæ™¯ã€ç›®æ ‡ç”¨æˆ·ã€é¢„æœŸæ•ˆæœç­‰</div>
                    </div>

                    <button type="submit" class="btn-primary">æäº¤éœ€æ±‚</button>
                </form>

                <div id="reqSuccess" class="success-message">
                    <h3>âœ… éœ€æ±‚æäº¤æˆåŠŸ!</h3>
                    <p>æ‚¨çš„è¿½è¸ªç :</p>
                    <div class="tracking-code" id="reqTrackingCode"></div>
                    <p style="color: var(--text-dim);">è¯·ä¿å­˜æ­¤è¿½è¸ªç ï¼Œæ‚¨å¯ä»¥éšæ—¶æŸ¥è¯¢è¯„å®¡è¿›åº¦ã€‚æˆ‘ä»¬ä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨è¯„å®¡ç»“æœã€‚</p>
                    <a id="reqGitlabLink" href="#" target="_blank" style="color: var(--primary);">æŸ¥çœ‹ GitLab Issue</a>
                </div>
            </div>
        </div>

        <!-- æŸ¥è¯¢å·¥å• -->
        <div id="trackTab" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 25px;">æŸ¥è¯¢å·¥å•çŠ¶æ€</h2>
                <div class="form-group">
                    <label>è¾“å…¥è¿½è¸ªç </label>
                    <input type="text" class="form-control" id="trackingCodeInput" placeholder="å¦‚: BUG-20241227-001">
                </div>
                <button class="btn-primary" onclick="trackTicket()">æŸ¥è¯¢</button>

                <div id="ticketResult" style="margin-top: 30px; display: none;">
                    <!-- å·¥å•è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>

                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 15px;">æˆ‘çš„å·¥å•</h3>
                    <div class="form-group">
                        <label>è¾“å…¥æ‚¨çš„é‚®ç®±æŸ¥çœ‹æ‰€æœ‰å·¥å•</label>
                        <input type="email" class="form-control" id="emailInput" placeholder="your@email.com">
                    </div>
                    <button class="btn-secondary" onclick="listMyTickets()">æŸ¥çœ‹æˆ‘çš„å·¥å•</button>
                    <div id="myTickets" style="margin-top: 20px;">
                        <!-- å·¥å•åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä» URL å‚æ•°è·å– project_id
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project_id') || prompt('è¯·è¾“å…¥ GitLab Project ID:');

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // æäº¤ Bug
        document.getElementById('bugForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                requester_name: document.getElementById('bug_name').value,
                requester_email: document.getElementById('bug_email').value,
                title: document.getElementById('bug_title').value,
                severity: document.getElementById('bug_severity').value,
                priority: document.getElementById('bug_priority').value,
                province: document.getElementById('bug_province').value,
                environment: document.getElementById('bug_environment').value,
                steps_to_repro: document.getElementById('bug_steps').value,
                actual_result: document.getElementById('bug_actual').value,
                expected_result: document.getElementById('bug_expected').value,
                attachments: []
            };

            try {
                const response = await fetch(`/service-desk/submit-bug?project_id=${projectId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('bugTrackingCode').textContent = result.tracking_code;
                    document.getElementById('bugGitlabLink').href = result.gitlab_issue_url;
                    document.getElementById('bugSuccess').style.display = 'block';
                    document.getElementById('bugForm').reset();
                } else {
                    alert('æäº¤å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        });

        // æäº¤éœ€æ±‚
        document.getElementById('reqForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                requester_name: document.getElementById('req_name').value,
                requester_email: document.getElementById('req_email').value,
                title: document.getElementById('req_title').value,
                description: document.getElementById('req_description').value,
                priority: document.getElementById('req_priority').value,
                req_type: document.getElementById('req_type').value,
                province: document.getElementById('req_province').value,
                expected_delivery: document.getElementById('req_delivery').value || null
            };

            try {
                const response = await fetch(`/service-desk/submit-requirement?project_id=${projectId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('reqTrackingCode').textContent = result.tracking_code;
                    document.getElementById('reqGitlabLink').href = result.gitlab_issue_url;
                    document.getElementById('reqSuccess').style.display = 'block';
                    document.getElementById('reqForm').reset();
                } else {
                    alert('æäº¤å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        });

        // æŸ¥è¯¢å·¥å•
        async function trackTicket() {
            const trackingCode = document.getElementById('trackingCodeInput').value.trim();
            if (!trackingCode) return alert('è¯·è¾“å…¥è¿½è¸ªç ');

            try {
                const response = await fetch(`/service-desk/track/${trackingCode}`);
                const ticket = await response.json();

                const statusClass = `status-${ticket.status}`;
                const statusText = {
                    'pending': 'å¾…å¤„ç†',
                    'in-progress': 'å¤„ç†ä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'rejected': 'å·²æ‹’ç»'
                }[ticket.status] || ticket.status;

                document.getElementById('ticketResult').innerHTML = `
                    <div class="ticket-card">
                        <div class="ticket-header">
                            <h3>${ticket.title}</h3>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <p><strong>è¿½è¸ªç :</strong> ${ticket.tracking_code}</p>
                        <p><strong>ç±»å‹:</strong> ${ticket.ticket_type === 'bug' ? 'ç¼ºé™·' : 'éœ€æ±‚'}</p>
                        <p><strong>æäº¤æ—¶é—´:</strong> ${new Date(ticket.created_at).toLocaleString('zh-CN')}</p>
                        <p><strong>æ›´æ–°æ—¶é—´:</strong> ${new Date(ticket.updated_at).toLocaleString('zh-CN')}</p>
                        ${ticket.gitlab_issue_url ? `<a href="${ticket.gitlab_issue_url}" target="_blank" style="color: var(--primary);">æŸ¥çœ‹è¯¦æƒ…</a>` : ''}
                    </div>
                `;
                document.getElementById('ticketResult').style.display = 'block';
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }

        // æŸ¥çœ‹æˆ‘çš„å·¥å•
        async function listMyTickets() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email) return alert('è¯·è¾“å…¥é‚®ç®±');

            try {
                const response = await fetch(`/service-desk/tickets?email=${encodeURIComponent(email)}`);
                const tickets = await response.json();

                if (tickets.length === 0) {
                    document.getElementById('myTickets').innerHTML = '<p style="color: var(--text-dim);">æš‚æ— å·¥å•</p>';
                    return;
                }

                document.getElementById('myTickets').innerHTML = tickets.map(ticket => {
                    const statusClass = `status-${ticket.status}`;
                    const statusText = {
                        'pending': 'å¾…å¤„ç†',
                        'in-progress': 'å¤„ç†ä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'rejected': 'å·²æ‹’ç»'
                    }[ticket.status] || ticket.status;

                    return `
                        <div class="ticket-card">
                            <div class="ticket-header">
                                <div>
                                    <strong>${ticket.title}</strong>
                                    <div style="font-size: 12px; color: var(--text-dim); margin-top: 5px;">
                                        ${ticket.tracking_code} | ${new Date(ticket.created_at).toLocaleDateString('zh-CN')}
                                    </div>
                                </div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            ${ticket.gitlab_issue_url ? `<a href="${ticket.gitlab_issue_url}" target="_blank" style="color: var(--primary); font-size: 14px;">æŸ¥çœ‹è¯¦æƒ… â†’</a>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                alert('æŸ¥è¯¢å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>

</html>