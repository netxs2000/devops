<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - Service Desk</title>
    <link href="css/main.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="auth_utils.js"></script>
    <script>
        // æƒé™å‡†å…¥æ ¡éªŒ
        if (!Auth.isLoggedIn() || !Auth.hasPermission('USER:MANAGE')) {
            document.addEventListener('DOMContentLoaded', () => {
                document.body.innerHTML = `
                    <div class="sys-unauthorized-overlay">
                        <div class="sys-unauthorized-icon">ğŸš«</div>
                        <h2 class="sys-unauthorized-title">æƒé™ä¸è¶³</h2>
                        <p class="sys-unauthorized-desc">æ‚¨æ²¡æœ‰è®¿é—®ç®¡ç†åå°çš„æƒé™ï¼Œè¯·é€šè¿‡ä¸»é¡µç”³è¯·ç›¸å…³æƒé™æˆ–è”ç³»ç®¡ç†å‘˜åˆ†é… USER:MANAGE æƒé™ã€‚</p>
                        <button onclick="window.parent.location.reload()" class="btn-primary">è¿”å›é¦–é¡µ</button>
                    </div>
                `;
            });
            throw new Error("Unauthorized access");
        }
    </script>
</head>

<body>
    <header class="u-p-24 u-w-full sd-header">
        <div class="u-flex u-flex-between u-mx-auto u-max-w-1400">
            <div class="u-text-primary u-weight-700 u-text-h2">
                Service Desk <span class="sys-tag u-v-middle u-ml-8">Admin</span>
            </div>
            <div id="adminInfo"></div>
        </div>
    </header>

    <div id="rejectModal" class="modal-overlay">
        <div class="modal u-max-w-500">
            <h3 class="u-mb-12 u-text-h3">æ‹’ç»æ³¨å†Œç”³è¯·</h3>
            <p class="u-text-dim u-mb-8 u-text-body">è¯·è¯´æ˜æ‹’ç»åŸå› ï¼š</p>
            <textarea id="rejectReason" class="form-control u-mb-20 u-h-100"
                placeholder="ä¾‹å¦‚ï¼šä¸æ˜¯ç›®æ ‡ç”¨æˆ·ã€ä¿¡æ¯ä¸å…¨ç­‰..."></textarea>
            <input type="hidden" id="rejectEmail">
            <div class="u-flex u-gap-10 u-flex-end">
                <button class="btn-ghost" onclick="closeRejectModal()">å–æ¶ˆ</button>
                <button class="btn-danger" onclick="submitReject()">ç¡®è®¤æ‹’ç»</button>
            </div>
        </div>
    </div>

    <main id="adminMain" class="u-mx-auto u-p-40 u-max-w-1400 u-hide">
        <div class="u-mb-32">
            <h1 class="u-text-primary u-text-display">ç”¨æˆ·ç®¡ç†</h1>
            <p class="u-text-dim u-text-h3">å®¡æ ¸æœåŠ¡å°ç”¨æˆ·çš„æ³¨å†Œç”³è¯·åŠç®¡ç†æƒé™</p>
        </div>

        <div class="sd-stats-grid u-mb-40" id="statsRow">
            <!-- Stats will be loaded here -->
        </div>

        <div class="sd-tabs u-mb-24">
            <div class="sd-tab is-active" onclick="loadTab('pending', this)">å¾…å®¡æ‰¹</div>
            <div class="sd-tab" onclick="loadTab('approved', this)">æ­£å¼ç”¨æˆ·</div>
            <div class="sd-tab" onclick="loadTab('rejected', this)">å·²æ‹’ç»</div>
            <div class="sd-tab" onclick="loadTab('all', this)">å…¨éƒ¨è®°å½•</div>
        </div>

        <div class="sd-admin-table-container">
            <table class="sd-table" id="userTable">
                <thead>
                    <tr>
                        <th>ç”¨æˆ·ä¿¡æ¯</th>
                        <th>å…¬å¸/éƒ¨é—¨</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>
    </main>

    <footer class="u-p-24 u-text-center u-text-dim sd-footer u-mt-48">
        <p>Â© 2025 TJHQ</p>
    </footer>

    <script>
        let currentTab = 'pending';

        async function loadData() {
            const container = document.getElementById('userTableBody');
            container.innerHTML = '<tr><td colspan="5" class="u-p-40 u-text-center u-text-dim">æ­£åœ¨åŠ è½½æ•°æ®...</td></tr>';

            try {
                let url = `/service-desk/admin/all-users`;
                const queryParams = new URLSearchParams();
                if (currentTab !== 'all') {
                    queryParams.append('status', currentTab);
                }

                const path = queryParams.toString() ? `${url}?${queryParams.toString()}` : url;
                const result = await Api.get(path);

                updateStats(result.stats);
                displayUsers(result.users);

            } catch (err) {
                container.innerHTML = `<tr><td colspan="5" class="u-p-40 u-text-center u-text-error">åŠ è½½å‡ºé”™: ${err.message}</td></tr>`;
            }
        }

        function updateStats(stats) {
            const row = document.getElementById('statsRow');
            row.innerHTML = `
                <div class="sd-stat-item">
                    <div class="sd-stat-label">å¾…å®¡æ‰¹</div>
                    <div class="sd-stat-value u-text-warning">${stats.pending}</div>
                </div>
                <div class="sd-stat-item">
                    <div class="sd-stat-label">æ­£å¼ç”¨æˆ·</div>
                    <div class="sd-stat-value u-text-success">${stats.approved}</div>
                </div>
                <div class="sd-stat-item">
                    <div class="sd-stat-label">å·²æ‹’ç»</div>
                    <div class="sd-stat-value u-text-error">${stats.rejected}</div>
                </div>
                <div class="sd-stat-item">
                    <div class="sd-stat-label">ç”¨æˆ·æ€»æ•°</div>
                    <div class="sd-stat-value">${stats.total}</div>
                </div>
            `;
        }

        function displayUsers(users) {
            const container = document.getElementById('userTableBody');
            if (!users || users.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="u-p-40 u-text-center u-text-dim">æš‚æ— ç”¨æˆ·è®°å½•</td></tr>`;
                return;
            }

            container.innerHTML = users.map(user => {
                const statusLabel = {
                    'pending': 'å¾…å¤„ç†',
                    'approved': 'å·²é€šè¿‡',
                    'rejected': 'å·²æ‹’ç»'
                }[user.status];

                const date = new Date(user.created_at).toLocaleString();

                return `
                    <tr>
                        <td class="u-p-16">
                            <div class="u-flex-column">
                                <span class="u-weight-600 u-text-primary u-text-body">${user.name}</span>
                                <span class="u-text-dim u-text-caption">${user.email}</span>
                            </div>
                        </td>
                        <td class="u-p-16 u-text-body">${user.company}</td>
                        <td class="u-p-16 u-text-dim u-text-caption">${date}</td>
                        <td class="u-p-16">
                            <span class="sd-badge sd-badge--${user.status}">${statusLabel}</span>
                            ${user.gitlab_user_id ? `<div class="u-text-primary u-mt-4 u-weight-500 u-text-tiny">GitLab ID: ${user.gitlab_user_id}</div>` : ''}
                        </td>
                        <td class="u-p-16">
                            ${user.status === 'pending' ? `
                                <div class="u-flex u-gap-10">
                                    <button class="btn-primary u-p-4 u-text-caption" onclick="approveWithId('${user.email}')">é€šè¿‡</button>
                                    <button class="btn-ghost u-p-4 u-text-caption u-text-error" onclick="openRejectModal('${user.email}')">æ‹’ç»</button>
                                </div>
                            ` : `
                                <span class="u-text-dim u-text-caption">
                                    ${user.status === 'rejected' ? `ç†ç”±: ${user.reject_reason || 'æ— '}` : 'å·²å¤„ç†'}
                                </span>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.sd-tab').forEach(t => t.classList.remove('is-active'));
            el.classList.add('is-active');
            loadData();
        }

        function approveWithId(email) {
            const gitlabId = prompt("è¯·è¾“å…¥è¦ä¸ºè¯¥ç”¨æˆ·ç»‘å®šçš„ GitLab User ID (å¯é€‰):", "1");
            if (gitlabId === null) return; // å–æ¶ˆ
            actionUser(email, true, '', gitlabId);
        }

        async function actionUser(email, approved, reason = '', gitlabId = '') {
            try {
                const params = {
                    email: email,
                    approved: approved
                };
                if (reason) params.reject_reason = reason;
                if (gitlabId) params.gitlab_user_id = gitlabId;

                const queryStr = new URLSearchParams(params).toString();
                await Api.post(`/service-desk/admin/approve-user?${queryStr}`, {});

                loadData();
            } catch (err) {
                alert(`æ“ä½œå¤±è´¥: ${err.message}`);
            }
        }

        function openRejectModal(email) {
            document.getElementById('rejectEmail').value = email;
            document.getElementById('rejectModal').classList.add('u-flex');
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').classList.remove('u-flex');
        }

        function submitReject() {
            const email = document.getElementById('rejectEmail').value;
            const reason = document.getElementById('rejectReason').value;
            if (!reason) {
                alert('è¯·å¡«å†™æ‹’ç»åŸå› ');
                return;
            }
            actionUser(email, false, reason);
            closeRejectModal();
        }

        // Initialize
        window.onload = () => {
            document.getElementById('adminMain').classList.remove('u-hide');
            loadData();
        };
    </script>
</body>

</html>